<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-cosmos-sdk docs-doc-id-docs/architecture/adr-054-semver-compatible-modules" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.3">
<title data-rh="true">ADR 054: Semver Compatible SDK Modules | Interchain Stack</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://docs-interchain.io/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-054-semver-compatible-modules"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-cosmos-sdk-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-cosmos-sdk-current"><meta data-rh="true" property="og:title" content="ADR 054: Semver Compatible SDK Modules | Interchain Stack"><meta data-rh="true" name="description" content="Changelog"><meta data-rh="true" property="og:description" content="Changelog"><link data-rh="true" rel="icon" href="/dev-portal-docsite/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://docs-interchain.io/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-054-semver-compatible-modules"><link data-rh="true" rel="alternate" href="https://docs-interchain.io/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-054-semver-compatible-modules" hreflang="en"><link data-rh="true" rel="alternate" href="https://docs-interchain.io/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-054-semver-compatible-modules" hreflang="x-default"><script src="https://widget.kapa.ai/kapa-widget.bundle.js" data-website-id="be413c15-3002-497e-9e30-676ea0039a9e" data-project-name="InterchainStack" data-project-color="#FFFFFF" data-button-text-color="#000" data-submit-query-button-bg-color="#000000" data-modal-disclaimer="InterchainGPT is a fine-tuned LLM for the Interchain with access to Interchain Stack developer documentation and resources. Please note that answers are generated by an AI so please use your best judgement before implementing" data-modal-image="img/spirograph.svg" data-project-logo="img/spirograph.svg" data-user-analytics-fingerprint-enabled="true" async></script><link rel="stylesheet" href="/dev-portal-docsite/assets/css/styles.3411b2aa.css">
<link rel="preload" href="/dev-portal-docsite/assets/js/runtime~main.e260afe7.js" as="script">
<link rel="preload" href="/dev-portal-docsite/assets/js/main.175a359f.js" as="script">
</head>
<body class="navigation-with-keyboard" data-theme="light">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}return t}()||function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarPlaceholder_vyr4"></div><div class="content_knG7 announcementBarContent_xLdY">The Interchain Stack Docsite is in MVP state; please submit comments with the feedback button. The Ask AI button is also very powerful.</div><button type="button" aria-label="Close" class="clean-btn close closeButton_CVFx announcementBarClose_gvF7"><svg viewBox="0 0 15 15" width="14" height="14"><g stroke="currentColor" stroke-width="3.1"><path d="M.75.75l13.5 13.5M14.25.75L.75 14.25"></path></g></svg></button></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/dev-portal-docsite/"><div class="navbar__logo"><img src="/dev-portal-docsite/img/interchain_logo.svg" alt="Interchain Docs" class="themedImage_ToTc themedImage--light_HNdA"><img src="/dev-portal-docsite/img/interchain_logo.svg" alt="Interchain Docs" class="themedImage_ToTc themedImage--dark_i4oU"></div></a><a class="navbar__item navbar__link" href="/dev-portal-docsite/onboarding">Onboarding</a><a class="navbar__item navbar__link" href="/dev-portal-docsite/ibc-go">IBC-Go</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/dev-portal-docsite/cosmos-sdk/learn">CosmosSDK</a><a href="https://docs.cometbft.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">CometBFT</a><a href="https://docs.cosmwasm.com/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">CosmWasm</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/dev-portal-docsite/cosmos-sdk/next/docs/learn/">Next</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-054-semver-compatible-modules">Next</a></li><li><a class="dropdown__link" href="/dev-portal-docsite/cosmos-sdk/learn/">0.52</a></li><li><a class="dropdown__link" href="/dev-portal-docsite/cosmos-sdk/0.50/learn/">0.50</a></li><li><a class="dropdown__link" href="/dev-portal-docsite/cosmos-sdk/0.47/learn/">0.47</a></li></ul></div><a href="https://github.com/interchainio/dev-portal-docsite" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" class="github-icon">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M12 0.300049C5.4 0.300049 0 5.70005 0 12.3001C0 17.6001 3.4 22.1001 8.2 23.7001C8.8 23.8001 9 23.4001 9 23.1001C9 22.8001 9 22.1001 9 21.1001C5.7 21.8001 5 19.5001 5 19.5001C4.5 18.1001 3.7 17.7001 3.7 17.7001C2.5 17.0001 3.7 17.0001 3.7 17.0001C4.9 17.1001 5.5 18.2001 5.5 18.2001C6.6 20.0001 8.3 19.5001 9 19.2001C9.1 18.4001 9.4 17.9001 9.8 17.6001C7.1 17.3001 4.3 16.3001 4.3 11.7001C4.3 10.4001 4.8 9.30005 5.5 8.50005C5.5 8.10005 5 6.90005 5.7 5.30005C5.7 5.30005 6.7 5.00005 9 6.50005C10 6.20005 11 6.10005 12 6.10005C13 6.10005 14 6.20005 15 6.50005C17.3 4.90005 18.3 5.30005 18.3 5.30005C19 7.00005 18.5 8.20005 18.4 8.50005C19.2 9.30005 19.6 10.4001 19.6 11.7001C19.6 16.3001 16.8 17.3001 14.1 17.6001C14.5 18.0001 14.9 18.7001 14.9 19.8001C14.9 21.4001 14.9 22.7001 14.9 23.1001C14.9 23.4001 15.1 23.8001 15.7 23.7001C20.5 22.1001 23.9 17.6001 23.9 12.3001C24 5.70005 18.6 0.300049 12 0.300049Z" fill="currentColor"/>
            </svg>
            </a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-cosmos-sdk-current,docs-onboarding-v0.50.x,docs-ibc-go-v8.5.x"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><main class="docMainContainer_gTbr docMainContainerEnhanced_Uz_u"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Interchain Stack<!-- --> <b>Next</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/dev-portal-docsite/cosmos-sdk/learn/">latest version</a></b> (<!-- -->0.52<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><span class="theme-doc-version-badge badge badge--secondary">Version: Next</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>ADR 054: Semver Compatible SDK Modules</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="changelog">Changelog<a href="#changelog" class="hash-link" aria-label="Direct link to Changelog" title="Direct link to Changelog">​</a></h2><ul><li>2022-04-27: First draft</li><li>2024-07-21: Second draft</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="status">Status<a href="#status" class="hash-link" aria-label="Direct link to Status" title="Direct link to Status">​</a></h2><p>DRAFT</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="abstract">Abstract<a href="#abstract" class="hash-link" aria-label="Direct link to Abstract" title="Direct link to Abstract">​</a></h2><p>In order to move the Cosmos SDK to a system of decoupled semantically versioned
modules which can be composed in different combinations (ex. staking v3 with
bank v1 and distribution v2), we need to reassess how we organize the API surface
of modules to avoid problems with go semantic import versioning and
circular dependencies. This ADR explores various approaches we can take to
addressing these issues.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="context">Context<a href="#context" class="hash-link" aria-label="Direct link to Context" title="Direct link to Context">​</a></h2><p>There has been <a href="https://github.com/cosmos/cosmos-sdk/discussions/10162" target="_blank" rel="noopener noreferrer">a fair amount of desire</a>
in the community for semantic versioning in the SDK and there has been significant
movement to splitting SDK modules into <a href="https://github.com/cosmos/cosmos-sdk/issues/11899" target="_blank" rel="noopener noreferrer">standalone go modules</a>.
Both of these will ideally allow the ecosystem to move faster because we won&#x27;t
be waiting for all dependencies to update synchronously. For instance, we could
have 3 versions of the core SDK compatible with the latest 2 releases of
CosmWasm as well as 4 different versions of staking . This sort of setup would
allow early adopters to aggressively integrate new versions, while allowing
more conservative users to be selective about which versions they&#x27;re ready for.</p><p>In order to achieve this, we need to solve the following problems:</p><ol><li>because of the way <a href="https://research.swtch.com/vgo-import" target="_blank" rel="noopener noreferrer">go semantic import versioning</a> (SIV)
works, moving to SIV naively will actually make it harder to achieve these goals</li><li>circular dependencies between modules need to be broken to actually release
many modules in the SDK independently</li><li>pernicious minor version incompatibilities introduced through correctly
<a href="https://protobuf.dev/programming-guides/proto3/#updating" target="_blank" rel="noopener noreferrer">evolving protobuf schemas</a>
without correct <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">unknown field filtering</a></li></ol><p>Note that all the following discussion assumes that the proto file versioning and state machine versioning of a module
are distinct in that:</p><ul><li>proto files are maintained in a non-breaking way (using something
like <a href="https://docs.buf.build/breaking/overview" target="_blank" rel="noopener noreferrer">buf breaking</a>
to ensure all changes are backwards compatible)</li><li>proto file versions get bumped much less frequently, i.e. we might maintain <code>cosmos.bank.v1</code> through many versions
of the bank module state machine</li><li>state machine breaking changes are more common and ideally this is what we&#x27;d want to semantically version with
go modules, ex. <code>x/bank/v2</code>, <code>x/bank/v3</code>, etc.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-1-semantic-import-versioning-compatibility">Problem 1: Semantic Import Versioning Compatibility<a href="#problem-1-semantic-import-versioning-compatibility" class="hash-link" aria-label="Direct link to Problem 1: Semantic Import Versioning Compatibility" title="Direct link to Problem 1: Semantic Import Versioning Compatibility">​</a></h3><p>Consider we have a module <code>foo</code> which defines the following <code>MsgDoSomething</code> and that we&#x27;ve released its state
machine in go module <code>example.com/foo</code>:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">package foo.v1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message MsgDoSomething {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string sender = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint64 amount = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">service Msg {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DoSomething(MsgDoSomething) returns (MsgDoSomethingResponse);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now consider that we make a revision to this module and add a new <code>condition</code> field to <code>MsgDoSomething</code> and also
add a new validation rule on <code>amount</code> requiring it to be non-zero, and that following go semantic versioning we
release the next state machine version of <code>foo</code> as <code>example.com/foo/v2</code>.</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Revision 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">package foo.v1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message MsgDoSomething {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string sender = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // amount must be a non-zero integer.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint64 amount = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // condition is an optional condition on doing the thing.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  //</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Since: Revision 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Condition condition = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Approaching this naively, we would generate the protobuf types for the initial
version of <code>foo</code> in <code>example.com/foo/types</code> and we would generate the protobuf
types for the second version in <code>example.com/foo/v2/types</code>.</p><p>Now let&#x27;s say we have a module <code>bar</code> which talks to <code>foo</code> using this keeper
interface which <code>foo</code> provides:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> FooKeeper </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DoSomething</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MsgDoSomething</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-a-backward-compatibility-newer-foo-older-bar">Scenario A: Backward Compatibility: Newer Foo, Older Bar<a href="#scenario-a-backward-compatibility-newer-foo-older-bar" class="hash-link" aria-label="Direct link to Scenario A: Backward Compatibility: Newer Foo, Older Bar" title="Direct link to Scenario A: Backward Compatibility: Newer Foo, Older Bar">​</a></h4><p>Imagine we have a chain which uses both <code>foo</code> and <code>bar</code> and wants to upgrade to
<code>foo/v2</code>, but the <code>bar</code> module has not upgraded to <code>foo/v2</code>.</p><p>In this case, the chain will not be able to upgrade to <code>foo/v2</code> until <code>bar</code>
has upgraded its references to <code>example.com/foo/types.MsgDoSomething</code> to
<code>example.com/foo/v2/types.MsgDoSomething</code>.</p><p>Even if <code>bar</code>&#x27;s usage of <code>MsgDoSomething</code> has not changed at all, the upgrade
will be impossible without this change because <code>example.com/foo/types.MsgDoSomething</code>
and <code>example.com/foo/v2/types.MsgDoSomething</code> are fundamentally different
incompatible structs in the go type system.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="scenario-b-forward-compatibility-older-foo-newer-bar">Scenario B: Forward Compatibility: Older Foo, Newer Bar<a href="#scenario-b-forward-compatibility-older-foo-newer-bar" class="hash-link" aria-label="Direct link to Scenario B: Forward Compatibility: Older Foo, Newer Bar" title="Direct link to Scenario B: Forward Compatibility: Older Foo, Newer Bar">​</a></h4><p>Now let&#x27;s consider the reverse scenario, where <code>bar</code> upgrades to <code>foo/v2</code>
by changing the <code>MsgDoSomething</code> reference to <code>example.com/foo/v2/types.MsgDoSomething</code>
and releases that as <code>bar/v2</code> with some other changes that a chain wants.
The chain, however, has decided that it thinks the changes in <code>foo/v2</code> are too
risky and that it&#x27;d prefer to stay on the initial version of <code>foo</code>.</p><p>In this scenario, it is impossible to upgrade to <code>bar/v2</code> without upgrading
to <code>foo/v2</code> even if <code>bar/v2</code> would have worked 100% fine with <code>foo</code> other
than changing the import path to <code>MsgDoSomething</code> (meaning that <code>bar/v2</code>
doesn&#x27;t actually use any new features of <code>foo/v2</code>).</p><p>Now because of the way go semantic import versioning works, we are locked
into either using <code>foo</code> and <code>bar</code> OR <code>foo/v2</code> and <code>bar/v2</code>. We cannot have
<code>foo</code> + <code>bar/v2</code> OR <code>foo/v2</code> + <code>bar</code>. The go type system doesn&#x27;t allow this
even if both versions of these modules are otherwise compatible with each
other.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="naive-mitigation">Naive Mitigation<a href="#naive-mitigation" class="hash-link" aria-label="Direct link to Naive Mitigation" title="Direct link to Naive Mitigation">​</a></h4><p>A naive approach to fixing this would be to not regenerate the protobuf types
in <code>example.com/foo/v2/types</code> but instead just update <code>example.com/foo/types</code>
to reflect the changes needed for <code>v2</code> (adding <code>condition</code> and requiring
<code>amount</code> to be non-zero). Then we could release a patch of <code>example.com/foo/types</code>
with this update and use that for <code>foo/v2</code>. But this change is state machine
breaking for <code>v1</code>. It requires changing the <code>ValidateBasic</code> method to reject
the case where <code>amount</code> is zero, and it adds the <code>condition</code> field which
should be rejected based
on <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">ADR 020 unknown field filtering</a>.
So adding these changes as a patch on <code>v1</code> is actually incorrect based on semantic
versioning. Chains that want to stay on <code>v1</code> of <code>foo</code> should not
be importing these changes because they are incorrect for <code>v1.</code></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-2-circular-dependencies">Problem 2: Circular dependencies<a href="#problem-2-circular-dependencies" class="hash-link" aria-label="Direct link to Problem 2: Circular dependencies" title="Direct link to Problem 2: Circular dependencies">​</a></h3><p>None of the above approaches allow <code>foo</code> and <code>bar</code> to be separate modules
if for some reason <code>foo</code> and <code>bar</code> depend on each other in different ways.
For instance, we can&#x27;t have <code>foo</code> import <code>bar/types</code> while <code>bar</code> imports
<code>foo/types</code>.</p><p>We have several cases of circular module dependencies in the SDK
(ex. staking, distribution and slashing) that are legitimate from a state machine
perspective. Without separating the API types out somehow, there would be
no way to independently semantically version these modules without some other
mitigation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="problem-3-handling-minor-version-incompatibilities">Problem 3: Handling Minor Version Incompatibilities<a href="#problem-3-handling-minor-version-incompatibilities" class="hash-link" aria-label="Direct link to Problem 3: Handling Minor Version Incompatibilities" title="Direct link to Problem 3: Handling Minor Version Incompatibilities">​</a></h3><p>Imagine that we solve the first two problems but now have a scenario where
<code>bar/v2</code> wants the option to use <code>MsgDoSomething.condition</code> which only <code>foo/v2</code>
supports. If <code>bar/v2</code> works with <code>foo</code> <code>v1</code> and sets <code>condition</code> to some non-nil
value, then <code>foo</code> will silently ignore this field resulting in a silent logic
possibly dangerous logic error. If <code>bar/v2</code> were able to check whether <code>foo</code> was
on <code>v1</code> or <code>v2</code> and dynamically, it could choose to only use <code>condition</code> when
<code>foo/v2</code> is available. Even if <code>bar/v2</code> were able to perform this check, however,
how do we know that it is always performing the check properly. Without
some sort of
framework-level <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">unknown field filtering</a>,
it is hard to know whether these pernicious hard to detect bugs are getting into
our app and a client-server layer such as <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-033-protobuf-inter-module-comm">ADR 033: Inter-Module Communication</a>
may be needed to do this.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="solutions">Solutions<a href="#solutions" class="hash-link" aria-label="Direct link to Solutions" title="Direct link to Solutions">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-a-separate-api-and-state-machine-modules">Approach A) Separate API and State Machine Modules<a href="#approach-a-separate-api-and-state-machine-modules" class="hash-link" aria-label="Direct link to Approach A) Separate API and State Machine Modules" title="Direct link to Approach A) Separate API and State Machine Modules">​</a></h3><p>One solution (first proposed in <a href="https://github.com/cosmos/cosmos-sdk/discussions/10582" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/discussions/10582</a>) is to isolate all protobuf
generated code into a separate module
from the state machine module. This would mean that we could have state machine
go modules <code>foo</code> and <code>foo/v2</code> which could use a types or API go module say
<code>foo/api</code>. This <code>foo/api</code> go module would be perpetually on <code>v1.x</code> and only
accept non-breaking changes. This would then allow other modules to be
compatible with either <code>foo</code> or <code>foo/v2</code> as long as the inter-module API only
depends on the types in <code>foo/api</code>. It would also allow modules <code>foo</code> and <code>bar</code>
to depend on each other in that both of them could depend on <code>foo/api</code> and
<code>bar/api</code> without <code>foo</code> directly depending on <code>bar</code> and vice versa.</p><p>This is similar to the naive mitigation described above except that it separates
the types into separate go modules which in and of itself could be used to
break circular module dependencies. It has the same problems as the naive solution,
otherwise, which we could rectify by:</p><ol><li>removing all state machine breaking code from the API module (ex. <code>ValidateBasic</code> and any other interface methods)</li><li>embedding the correct file descriptors for unknown field filtering in the binary</li></ol><h4 class="anchor anchorWithStickyNavbar_LWe7" id="migrate-all-interface-methods-on-api-types-to-handlers">Migrate all interface methods on API types to handlers<a href="#migrate-all-interface-methods-on-api-types-to-handlers" class="hash-link" aria-label="Direct link to Migrate all interface methods on API types to handlers" title="Direct link to Migrate all interface methods on API types to handlers">​</a></h4><p>To solve 1), we need to remove all interface implementations from generated
types and instead use a handler approach which essentially means that given
a type <code>X</code>, we have some sort of resolver which allows us to resolve interface
implementations for that type (ex. <code>sdk.Msg</code> or <code>authz.Authorization</code>). For
example:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k Keeper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">DoSomething</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg MsgDoSomething</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> validateBasicHandler ValidateBasicHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">:=</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">resolver</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">Resolve</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">validateBasicHandler</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> msg</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> err </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">nil</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> err</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain">   </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    err </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> validateBasicHandler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">ValidateBasic</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the case of some methods on <code>sdk.Msg</code>, we could replace them with declarative
annotations. For instance, <code>GetSigners</code> can already be replaced by the protobuf
annotation <code>cosmos.msg.v1.signer</code>. In the future, we may consider some sort
of protobuf validation framework (like <a href="https://github.com/bufbuild/protoc-gen-validate" target="_blank" rel="noopener noreferrer">https://github.com/bufbuild/protoc-gen-validate</a>
but more Cosmos-specific) to replace <code>ValidateBasic</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pinned-filedescriptors">Pinned FileDescriptor&#x27;s<a href="#pinned-filedescriptors" class="hash-link" aria-label="Direct link to Pinned FileDescriptor&#x27;s" title="Direct link to Pinned FileDescriptor&#x27;s">​</a></h4><p>To solve 2), state machine modules must be able to specify what the version of
the protobuf files was that they were built against. For instance if the API
module for <code>foo</code> upgrades to <code>foo/v2</code>, the original <code>foo</code> module still needs
a copy of the original protobuf files it was built with so that ADR 020
unknown field filtering will reject <code>MsgDoSomething</code> when <code>condition</code> is
set.</p><p>The simplest way to do this may be to embed the protobuf <code>FileDescriptor</code>s into
the module itself so that these <code>FileDescriptor</code>s are used at runtime rather
than the ones that are built into the <code>foo/api</code> which may be different. Using
<a href="https://docs.buf.build/build/usage#output-format" target="_blank" rel="noopener noreferrer">buf build</a>, <a href="https://pkg.go.dev/embed" target="_blank" rel="noopener noreferrer">go embed</a>,
and a build script we can probably come up with a solution for embedding
<code>FileDescriptor</code>s into modules that is fairly straightforward.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="potential-limitations-to-generated-code">Potential limitations to generated code<a href="#potential-limitations-to-generated-code" class="hash-link" aria-label="Direct link to Potential limitations to generated code" title="Direct link to Potential limitations to generated code">​</a></h4><p>One challenge with this approach is that it places heavy restrictions on what
can go in API modules and requires that most of this is state machine breaking.
All or most of the code in the API module would be generated from protobuf
files, so we can probably control this with how code generation is done, but
it is a risk to be aware of.</p><p>For instance, we do code generation for the ORM that in the future could
contain optimizations that are state machine breaking. We
would either need to ensure very carefully that the optimizations aren&#x27;t
actually state machine breaking in generated code or separate this generated code
out from the API module into the state machine module. Both of these mitigations
are potentially viable but the API module approach does require an extra level
of care to avoid these sorts of issues.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="minor-version-incompatibilities">Minor Version Incompatibilities<a href="#minor-version-incompatibilities" class="hash-link" aria-label="Direct link to Minor Version Incompatibilities" title="Direct link to Minor Version Incompatibilities">​</a></h4><p>This approach in and of itself does little to address any potential minor
version incompatibilities and the
requisite <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">unknown field filtering</a>.
Likely some sort of client-server routing layer which does this check such as
<a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-033-protobuf-inter-module-comm">ADR 033: Inter-Module communication</a>
is required to make sure that this is done properly. We could then allow
modules to perform a runtime check given a <code>MsgClient</code>, ex:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k Keeper</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">CallFoo</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">interModuleClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">MinorRevision</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fooMsgClient</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        k</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fooMsgClient</span><span class="token punctuation" style="color:#393A34">.</span><span class="token function" style="color:#d73a49">DoSomething</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">MsgDoSomething</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">Condition</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token operator" style="color:#393A34">...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>To do the unknown field filtering itself, the ADR 033 router would need to use
the <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect" target="_blank" rel="noopener noreferrer">protoreflect API</a>
to ensure that no fields unknown to the receiving module are set. This could
result in an undesirable performance hit depending on how complex this logic is.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="no-new-fields-in-existing-protobuf-messages">No New Fields in Existing Protobuf Messages<a href="#no-new-fields-in-existing-protobuf-messages" class="hash-link" aria-label="Direct link to No New Fields in Existing Protobuf Messages" title="Direct link to No New Fields in Existing Protobuf Messages">​</a></h4><p>An alternative to addressing minor version incompatibilities as described above is disallowing new fields in existing protobuf messages. While this is more restrictive, it simplifies versioning and eliminates the need for runtime unknown field checking. In addition, this approach would simplify cross language communication with the proposed <a href="/dev-portal-docsite/cosmos-sdk/next/docs/rfc/rfc-002-zero-copy-encoding">RFC 002: Zero Copy Encoding</a>. So, while it is rather restrictive, it has gained a fair amount of support.</p><p>Although disallowing new fields may seem overly restrictive, there is a straightforward way to work around it using protobuf <code>oneof</code>s. Because <code>oneof</code> and <code>enum</code> cases must get processed through a <code>switch</code> statement, adding new cases is not problematic because any unknown cases can be handled by a <code>default</code> clause. The router layer wouldn&#x27;t need to do unknown field filtering for these because the <code>switch</code> statement is a native way to do this. If we needed to add new fields to <code>MsgDoSomething</code> from above and retain the possibility of adding more new fields in the future, we could do something like this:</p><div class="language-protobuf codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-protobuf codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">message MsgDoSomethingWithOptions {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  string sender = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  uint64 amount = 2;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repeated MsgDoSomethingOption options = 3;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">message MsgDoSomethingOption {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  oneof option {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Condition condition = 1;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>New <code>oneof</code> cases can be added to <code>MsgDoSomethingOption</code> and this has a similar effect as adding new fields to <code>MsgDoSomethingWithOptions</code> but no new fields are needed. A similar strategy is recommended for adding variadic options to golang functions in <a href="https://go.dev/blog/module-compatibility" target="_blank" rel="noopener noreferrer">https://go.dev/blog/module-compatibility</a> and expanded upon in <a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html" target="_blank" rel="noopener noreferrer">https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-b-changes-to-generated-code-to-a-gettersetter-api">Approach B) Changes to Generated Code to a Getter/Setter API<a href="#approach-b-changes-to-generated-code-to-a-gettersetter-api" class="hash-link" aria-label="Direct link to Approach B) Changes to Generated Code to a Getter/Setter API" title="Direct link to Approach B) Changes to Generated Code to a Getter/Setter API">​</a></h3><p>An alternate approach to solving the versioning problem is to change how protobuf code is generated and move modules
mostly or completely in the direction of inter-module communication as described
in <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-033-protobuf-inter-module-comm">ADR 033</a>.
In this paradigm, a module could generate all the types it needs internally - including the API types of other modules -
and talk to other modules via a client-server boundary. For instance, if <code>bar</code> needs to talk to <code>foo</code>, it could
generate its own version of <code>MsgDoSomething</code> as <code>bar/internal/foo/v1.MsgDoSomething</code> and just pass this to the
inter-module router which would somehow convert it to the version which foo needs (ex. <code>foo/internal.MsgDoSomething</code>).</p><p>Currently, two generated structs for the same protobuf type cannot exist in the same go binary without special
build flags (see <a href="https://protobuf.dev/reference/go/faq/#fix-namespace-conflict" target="_blank" rel="noopener noreferrer">https://protobuf.dev/reference/go/faq/#fix-namespace-conflict</a>).
A relatively simple mitigation to this issue would be to set up the protobuf code to not register protobuf types
globally if they are generated in an <code>internal/</code> package. This will require modules to register their types manually
with the app-level level protobuf registry, this is similar to what modules already do with the <code>InterfaceRegistry</code>
and amino codec.</p><p>If modules <em>only</em> do ADR 033 message passing then a naive and non-performant solution for
converting <code>bar/internal/foo/v1.MsgDoSomething</code>
to <code>foo/internal.MsgDoSomething</code> would be marshaling and unmarshaling in the ADR 033 router. This would break down if
we needed to expose protobuf types in <code>Keeper</code> interfaces because the whole point is to try to keep these types
<code>internal/</code> so that we don&#x27;t end up with all the import version incompatibilities we&#x27;ve described above. However,
because of the issue with minor version incompatibilities and the need
for <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">unknown field filtering</a>,
sticking with the <code>Keeper</code> paradigm instead of ADR 033 may be unviable to begin with.</p><p>A more performant solution (that could maybe be adapted to work with <code>Keeper</code> interfaces) would be to only expose
getters and setters for generated types and internally store data in memory buffers which could be passed from
one implementation to another in a zero-copy way.</p><p>For example, imagine this protobuf API with only getters and setters is exposed for <code>MsgSend</code>:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> MsgSend </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    proto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetFromAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetToAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetAmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">v1beta1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Coin</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetFromAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetToAddress</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetAmount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain">v1beta1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Coin</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">func</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">NewMsgSend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> MsgSend </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&amp;</span><span class="token plain">msgSendImpl</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">memoryBuffers</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">...</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Under the hood, <code>MsgSend</code> could be implemented based on some raw memory buffer in the same way
that <a href="https://capnproto.org" target="_blank" rel="noopener noreferrer">Cap&#x27;n Proto</a>
and <a href="https://google.github.io/flatbuffers/" target="_blank" rel="noopener noreferrer">FlatBuffers</a> so that we could convert between one version of <code>MsgSend</code>
and another without serialization (i.e. zero-copy). This approach would have the added benefits of allowing zero-copy
message passing to modules written in other languages such as Rust and accessed through a VM or FFI. It could also make
unknown field filtering in inter-module communication simpler if we require that all new fields are added in sequential
order, ex. just checking that no field <code>&gt; 5</code> is set.</p><p>Also, we wouldn&#x27;t have any issues with state machine breaking code on generated types because all the generated
code used in the state machine would actually live in the state machine module itself. Depending on how interface
types and protobuf <code>Any</code>s are used in other languages, however, it may still be desirable to take the handler
approach described in approach A. Either way, types implementing interfaces would still need to be registered
with an <code>InterfaceRegistry</code> as they are now because there would be no way to retrieve them via the global registry.</p><p>In order to simplify access to other modules using ADR 033, a public API module (maybe even one
<a href="https://buf.build/docs/migration-guides/migrate-remote-generation-alpha" target="_blank" rel="noopener noreferrer">remotely generated by Buf</a>) could be used by client modules instead
of requiring to generate all client types internally.</p><p>The big downsides of this approach are that it requires big changes to how people use protobuf types and would be a
substantial rewrite of the protobuf code generator. This new generated code, however, could still be made compatible
with
the <a href="https://pkg.go.dev/google.golang.org/protobuf/reflect/protoreflect" target="_blank" rel="noopener noreferrer"><code>google.golang.org/protobuf/reflect/protoreflect</code></a>
API in order to work with all standard golang protobuf tooling.</p><p>It is possible that the naive approach of marshaling/unmarshaling in the ADR 033 router is an acceptable intermediate
solution if the changes to the code generator are seen as too complex. However, since all modules would likely need
to migrate to ADR 033 anyway with this approach, it might be better to do this all at once.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-c-dont-address-these-issues">Approach C) Don&#x27;t address these issues<a href="#approach-c-dont-address-these-issues" class="hash-link" aria-label="Direct link to Approach C) Don&#x27;t address these issues" title="Direct link to Approach C) Don&#x27;t address these issues">​</a></h3><p>If the above solutions are seen as too complex, we can also decide not to do anything explicit to enable better module
version compatibility, and break circular dependencies.</p><p>In this case, when developers are confronted with the issues described above they can require dependencies to update in
sync (what we do now) or attempt some ad-hoc potentially hacky solution.</p><p>One approach is to ditch go semantic import versioning (SIV) altogether. Some people have commented that go&#x27;s SIV
(i.e. changing the import path to <code>foo/v2</code>, <code>foo/v3</code>, etc.) is too restrictive and that it should be optional. The
golang maintainers disagree and only officially support semantic import versioning. We could, however, take the
contrarian perspective and get more flexibility by using 0.x-based versioning basically forever.</p><p>Module version compatibility could then be achieved using go.mod replace directives to pin dependencies to specific
compatible 0.x versions. For instance if we knew <code>foo</code> 0.2 and 0.3 were both compatible with <code>bar</code> 0.3 and 0.4, we
could use replace directives in our go.mod to stick to the versions of <code>foo</code> and <code>bar</code> we want. This would work as
long as the authors of <code>foo</code> and <code>bar</code> avoid incompatible breaking changes between these modules.</p><p>Or, if developers choose to use semantic import versioning, they can attempt the naive solution described above
and would also need to use special tags and replace directives to make sure that modules are pinned to the correct
versions.</p><p>Note, however, that all of these ad-hoc approaches, would be vulnerable to the minor version compatibility issues
described above unless <a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding#unknown-field-filtering">unknown field filtering</a>
is properly addressed.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-d-avoid-protobuf-generated-code-in-public-apis">Approach D) Avoid protobuf generated code in public APIs<a href="#approach-d-avoid-protobuf-generated-code-in-public-apis" class="hash-link" aria-label="Direct link to Approach D) Avoid protobuf generated code in public APIs" title="Direct link to Approach D) Avoid protobuf generated code in public APIs">​</a></h3><p>An alternative approach would be to avoid protobuf generated code in public module APIs. This would help avoid the
discrepancy between state machine versions and client API versions at the module to module boundaries. It would mean
that we wouldn&#x27;t do inter-module message passing based on ADR 033, but rather stick to the existing keeper approach
and take it one step further by avoiding any protobuf generated code in the keeper interface methods.</p><p>Using this approach, our <code>foo.Keeper.DoSomething</code> method wouldn&#x27;t have the generated <code>MsgDoSomething</code> struct (which
comes from the protobuf API), but instead positional parameters. Then in order for <code>foo/v2</code> to support the <code>foo/v1</code>
keeper it would simply need to implement both the v1 and v2 keeper APIs. The <code>DoSomething</code> method in v2 could have the
additional <code>condition</code> parameter, but this wouldn&#x27;t be present in v1 at all so there would be no danger of a client
accidentally setting this when it isn&#x27;t available. </p><p>So this approach would avoid the challenge around minor version incompatibilities because the existing module keeper
API would not get new fields when they are added to protobuf files.</p><p>Taking this approach, however, would likely require making all protobuf generated code internal in order to prevent
it from leaking into the keeper API. This means we would still need to modify the protobuf code generator to not
register <code>internal/</code> code with the global registry, and we would still need to manually register protobuf
<code>FileDescriptor</code>s (this is probably true in all scenarios). It may, however, be possible to avoid needing to refactor
interface methods on generated types to handlers.</p><p>Also, this approach doesn&#x27;t address what would be done in scenarios where modules still want to use the message router.
Either way, we probably still want a way to pass messages from one module to another router safely even if it&#x27;s just for
use cases like <code>x/gov</code>, <code>x/authz</code>, CosmWasm, etc. That would still require most of the things outlined in approach (B),
although we could advise modules to prefer keepers for communicating with other modules.</p><p>The biggest downside of this approach is probably that it requires a strict refactoring of keeper interfaces to avoid
generated code leaking into the API. This may result in cases where we need to duplicate types that are already defined
in proto files and then write methods for converting between the golang and protobuf version. This may end up in a lot
of unnecessary boilerplate and that may discourage modules from actually adopting it and achieving effective version
compatibility. Approaches (A) and (B), although heavy handed initially, aim to provide a system which once adopted
more or less gives the developer version compatibility for free with minimal boilerplate. Approach (D) may not be able
to provide such a straightforward system since it requires a golang API to be defined alongside a protobuf API in a
way that requires duplication and differing sets of design principles (protobuf APIs encourage additive changes
while golang APIs would forbid it).</p><p>Other downsides to this approach are:</p><ul><li>no clear roadmap to supporting modules in other languages like Rust</li><li>doesn&#x27;t get us any closer to proper object capability security (one of the goals of ADR 033)</li><li>ADR 033 needs to be done properly anyway for the set of use cases which do need it</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="approach-e-use-structural-typing-in-inter-module-apis-avoid-new-fields-on-messages">Approach E) Use Structural Typing in Inter-module APIs, Avoid New Fields on Messages<a href="#approach-e-use-structural-typing-in-inter-module-apis-avoid-new-fields-on-messages" class="hash-link" aria-label="Direct link to Approach E) Use Structural Typing in Inter-module APIs, Avoid New Fields on Messages" title="Direct link to Approach E) Use Structural Typing in Inter-module APIs, Avoid New Fields on Messages">​</a></h3><p>The current non-router based approach for inter-module communication is for a module to define a <code>Keeper</code> interface and for a consumer module to define an expected keeper interface with a subset of the keeper&#x27;s methods. Such an interface can allow one module to avoid a direct dependency on another module if no concrete types need to be imported from the other module. For instance, if we had a method <code>DoSomething(context.Context, string, uint64)</code> as in <code>foo.v1</code>, then a module calling <code>DoSomething</code> would not need to import <code>foo</code> directly. If, however, we had a struct parameter such as <code>Condition</code> and the new method were <code>DoSomethingV2(context.Context, string, uint64, foo.Condition)</code> then a calling module would generally need to import foo just to get a reference to the <code>foo.Condition</code> struct.</p><p>Golang, however, supports both structural and nominal typing. Nominal typing means that two types equivalent if and only if they have the same name. Structural typing in golang means that two types are equivalent if they have the same structure and are unnamed. So if we defined <code>Condition</code> nominally it might look like <code>type Condition struct { Field1 string }</code> and if we defined it structurally it would look like <code>type Condition = struct { Field1 string }</code>. If <code>Condition</code> were defined structurally we could use the expected keeper approach and a calling module <em>would not</em> need to import <code>foo</code> at all to define the <code>DoSomethingV2</code> method in its expected keeper interface. Structural typing avoids the dependency problems described above.</p><p>We could actually extend this structural typing paradigm to protobuf generated code <em>if</em> we disallow adding new fields to existing protobuf messages. This would be required because two struct types are only identical if their fields are identical. If even the order of fields in a struct or the struct tags change, then golang considers the structs as different types. While this is fairly restrictive, it is under consideration for approach A) and <a href="/dev-portal-docsite/cosmos-sdk/next/docs/rfc/rfc-002-zero-copy-encoding">RFC 002</a> as well and has gained a fair amount of support.</p><p>Small modifications to the existing pulsar code generator could potentially generate code that uses structural typing and moves the implementation of protobuf interfaces to wrapper types because unnamed structs can&#x27;t define methods. Here&#x27;s an example of what this might look like:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> MsgDoSomething </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Sender </span><span class="token builtin">string</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Amount </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">MsgDoSomething_Message</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">MsgDoSomething</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// MsgDoSomething_Message would actually implement protobuf methods</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">_</span><span class="token plain"> proto</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Message </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token plain">MsgDoSomething_Message</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token boolean" style="color:#36acaa">nil</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At least at the message layer, such an API wouldn&#x27;t pose a problem because the transaction decoder does message decoding and modules wouldn&#x27;t need to interact with the <code>proto.Message</code> interface directly.</p><p>In order to avoid problems with the global protobuf registry, the structural typing generated code would only register message descriptors with the global registry but not register message types. This would allow two modules to generate the same protobuf types in different packages without causing a conflict. Because the types are defined structurally, they would actually be the <em>same</em> types but no direct import would be required. In order to ensure compatibility, when message descriptors are registered at startup, a check would be required to ensure that messages are identical (i.e. no new fields).</p><p>With this approach, a module <code>bar</code> calling module <code>foo</code> could either import <code>foo</code> directly to get its types or generate its own set of compatible types for <code>foo</code>s API. The dependency problem is essentially solved with this approach without needing any sort of special discipline around a separate API module. The main discipline would be around versioning protobuf APIs correctly and not adding new fields.</p><p>Taking this approach one step further, we could potentially even define APIs that unwrap the request and response types, i.e. <code>DoSomething(context.Context, string, uint64) error</code> vs <code>DoSomething(context.Context, MsgDoSomething) (MsgDoSomethingResponse, error)</code>. Or, APIs could even be defined directly in golang and the <code>.proto</code> files plus marshaling code could be generated via <code>go generate</code>. Ex:</p><div class="language-go codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-go codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> foo </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;context&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//go:generate go run github.com/cosmos/cosmos-proto/cmd/structproto</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> Msg </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">DoSomething</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">Context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>While having the limitation of not allowing new fields to be added to existing structs, approach E) has the following benefits:</p><ul><li>unlike approach A), api types can be generated in the same go module, but direct imports can always be avoided</li><li>generated client/server code could look more like regular go interfaces (without needing a set of intermediate structs)</li><li>keeper interface defined in <code>.go</code> files could be turned into protobuf APIs (rather than needing to write <code>.proto</code> files)</li><li>SDK modules could adopt go semantic versioning without any of the issues described above, achieving the initially stated goals of this ADR</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="decision">Decision<a href="#decision" class="hash-link" aria-label="Direct link to Decision" title="Direct link to Decision">​</a></h2><p>There has been no decision yet, and the SDK has more or less been following approach C) and official adoption of <a href="https://0ver.org" target="_blank" rel="noopener noreferrer">0ver</a> as a policy has been discussed. The issue of decoupling modules, properly versioning protobuf types, avoiding breakage, and adopting semver continue to arise from time to time. The most serious alternatives under consideration currently are approaches A) and E). The remainder of this ADR has been left blank and will be filled in when and if there is further convergence on a solution.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="consequences">Consequences<a href="#consequences" class="hash-link" aria-label="Direct link to Consequences" title="Direct link to Consequences">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="backwards-compatibility">Backwards Compatibility<a href="#backwards-compatibility" class="hash-link" aria-label="Direct link to Backwards Compatibility" title="Direct link to Backwards Compatibility">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="positive">Positive<a href="#positive" class="hash-link" aria-label="Direct link to Positive" title="Direct link to Positive">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="negative">Negative<a href="#negative" class="hash-link" aria-label="Direct link to Negative" title="Direct link to Negative">​</a></h3><h3 class="anchor anchorWithStickyNavbar_LWe7" id="neutral">Neutral<a href="#neutral" class="hash-link" aria-label="Direct link to Neutral" title="Direct link to Neutral">​</a></h3><h2 class="anchor anchorWithStickyNavbar_LWe7" id="further-discussions">Further Discussions<a href="#further-discussions" class="hash-link" aria-label="Direct link to Further Discussions" title="Direct link to Further Discussions">​</a></h2><h2 class="anchor anchorWithStickyNavbar_LWe7" id="references">References<a href="#references" class="hash-link" aria-label="Direct link to References" title="Direct link to References">​</a></h2><ul><li><a href="https://github.com/cosmos/cosmos-sdk/discussions/10162" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/discussions/10162</a></li><li><a href="https://github.com/cosmos/cosmos-sdk/discussions/10582" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/discussions/10582</a></li><li><a href="https://github.com/cosmos/cosmos-sdk/discussions/10368" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/discussions/10368</a></li><li><a href="https://github.com/cosmos/cosmos-sdk/pull/11340" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/pull/11340</a></li><li><a href="https://github.com/cosmos/cosmos-sdk/issues/11899" target="_blank" rel="noopener noreferrer">https://github.com/cosmos/cosmos-sdk/issues/11899</a></li><li><a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-020-protobuf-transaction-encoding">ADR 020</a></li><li><a href="/dev-portal-docsite/cosmos-sdk/next/docs/architecture/adr-033-protobuf-inter-module-comm">ADR 033</a></li></ul></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#changelog" class="table-of-contents__link toc-highlight">Changelog</a></li><li><a href="#status" class="table-of-contents__link toc-highlight">Status</a></li><li><a href="#abstract" class="table-of-contents__link toc-highlight">Abstract</a></li><li><a href="#context" class="table-of-contents__link toc-highlight">Context</a><ul><li><a href="#problem-1-semantic-import-versioning-compatibility" class="table-of-contents__link toc-highlight">Problem 1: Semantic Import Versioning Compatibility</a></li><li><a href="#problem-2-circular-dependencies" class="table-of-contents__link toc-highlight">Problem 2: Circular dependencies</a></li><li><a href="#problem-3-handling-minor-version-incompatibilities" class="table-of-contents__link toc-highlight">Problem 3: Handling Minor Version Incompatibilities</a></li></ul></li><li><a href="#solutions" class="table-of-contents__link toc-highlight">Solutions</a><ul><li><a href="#approach-a-separate-api-and-state-machine-modules" class="table-of-contents__link toc-highlight">Approach A) Separate API and State Machine Modules</a></li><li><a href="#approach-b-changes-to-generated-code-to-a-gettersetter-api" class="table-of-contents__link toc-highlight">Approach B) Changes to Generated Code to a Getter/Setter API</a></li><li><a href="#approach-c-dont-address-these-issues" class="table-of-contents__link toc-highlight">Approach C) Don&#39;t address these issues</a></li><li><a href="#approach-d-avoid-protobuf-generated-code-in-public-apis" class="table-of-contents__link toc-highlight">Approach D) Avoid protobuf generated code in public APIs</a></li><li><a href="#approach-e-use-structural-typing-in-inter-module-apis-avoid-new-fields-on-messages" class="table-of-contents__link toc-highlight">Approach E) Use Structural Typing in Inter-module APIs, Avoid New Fields on Messages</a></li></ul></li><li><a href="#decision" class="table-of-contents__link toc-highlight">Decision</a></li><li><a href="#consequences" class="table-of-contents__link toc-highlight">Consequences</a><ul><li><a href="#backwards-compatibility" class="table-of-contents__link toc-highlight">Backwards Compatibility</a></li><li><a href="#positive" class="table-of-contents__link toc-highlight">Positive</a></li><li><a href="#negative" class="table-of-contents__link toc-highlight">Negative</a></li><li><a href="#neutral" class="table-of-contents__link toc-highlight">Neutral</a></li></ul></li><li><a href="#further-discussions" class="table-of-contents__link toc-highlight">Further Discussions</a></li><li><a href="#references" class="table-of-contents__link toc-highlight">References</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"></ul></div><div class="col footer__col"><div class="footer__title">Stack Components</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/cosmos/ibc-go" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC-Go<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/cosmos/cosmos-sdk" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmosSDK<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/cometbft/cometbft" target="_blank" rel="noopener noreferrer" class="footer__link-item">CometBFT<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/CosmWasm/cosmwasm" target="_blank" rel="noopener noreferrer" class="footer__link-item">CosmWasm<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/cosmos/relayer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Go Relayer<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://hermes.informal.systems/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Hermes Relayer<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/cosmos/ibc-rs" target="_blank" rel="noopener noreferrer" class="footer__link-item">IBC-rs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/strangelove-ventures/interchaintest" target="_blank" rel="noopener noreferrer" class="footer__link-item">Interchaintest<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://discord.com/invite/interchain" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/interchain_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/@interchain_io" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://interchain.io/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2025 <a href="https://interchain.io/">Interchain Foundation</a>. All rights reserved.</div></div></div></footer></div>
<script src="/dev-portal-docsite/assets/js/runtime~main.e260afe7.js"></script>
<script src="/dev-portal-docsite/assets/js/main.175a359f.js"></script>
</body>
</html>