"use strict";(self.webpackChunkdev_portal_docsite=self.webpackChunkdev_portal_docsite||[]).push([[86263],{15680:(e,t,a)=>{a.d(t,{xA:()=>c,yg:()=>h});var r=a(96540);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,r)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,r,n=function(e,t){if(null==e)return{};var a,r,n={},i=Object.keys(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)a=i[r],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=r.createContext({}),d=function(e){var t=r.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},c=function(e){var t=d(e.components);return r.createElement(l.Provider,{value:t},e.children)},p="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},u=r.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,l=e.parentName,c=o(e,["components","mdxType","originalType","parentName"]),p=d(a),u=n,h=p["".concat(l,".").concat(u)]||p[u]||g[u]||i;return a?r.createElement(h,s(s({ref:t},c),{},{components:a})):r.createElement(h,s({ref:t},c))}));function h(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,s=new Array(i);s[0]=u;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[p]="string"==typeof e?e:n,s[1]=o;for(var d=2;d<i;d++)s[d]=a[d];return r.createElement.apply(null,s)}return r.createElement.apply(null,a)}u.displayName="MDXCreateElement"},45666:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>i,metadata:()=>o,toc:()=>d});var r=a(58168),n=(a(96540),a(15680));const i={title:"CW Validator Reviews",sidebar_label:"CosmWasm Validator Reviews",slug:"/demo/cw-validator-reviews"},s="CosmWasm Validator Reviews",o={unversionedId:"demos/cw-validator-reviews",id:"version-v0.50.x/demos/cw-validator-reviews",title:"CW Validator Reviews",description:"You will build a new chain with CosmWasm, enabling a proof-of-stake validator review system. You will write a contract to collect and manage validator reviews, integrate it with the chain, and update validator data automatically through the Cosmos-SDK endblocker module.",source:"@site/onboarding_versioned_docs/version-v0.50.x/03-demos/04-cw-validator-reviews.md",sourceDirName:"03-demos",slug:"/demo/cw-validator-reviews",permalink:"/dev-portal-docsite/onboarding/demo/cw-validator-reviews",draft:!1,tags:[],version:"v0.50.x",sidebarPosition:4,frontMatter:{title:"CW Validator Reviews",sidebar_label:"CosmWasm Validator Reviews",slug:"/demo/cw-validator-reviews"},sidebar:"defaultSidebar",previous:{title:"Token Factory",permalink:"/dev-portal-docsite/onboarding/demo/tokenfactory"},next:{title:"Network Security Types",permalink:"/dev-portal-docsite/onboarding/learn/consensus-security"}},l={},d=[{value:"Prerequisites",id:"prerequisites",level:2},{value:"Setup the Chain",id:"setup-the-chain",level:2},{value:"CosmWasm Build Contract",id:"cosmwasm-build-contract",level:2},{value:"Set State",id:"set-state",level:3},{value:"Set Inputs",id:"set-inputs",level:3},{value:"Set new error",id:"set-new-error",level:3},{value:"Imports",id:"imports",level:3},{value:"Modify Instantiate Message",id:"modify-instantiate-message",level:3},{value:"Add Execute Logic",id:"add-execute-logic",level:3},{value:"Add Queries",id:"add-queries",level:3},{value:"Add New Sudo Message Type",id:"add-new-sudo-message-type",level:3},{value:"Build the Contract",id:"build-the-contract",level:3},{value:"Modify the Module",id:"modify-the-module",level:2},{value:"Setup the Keeper",id:"setup-the-keeper",level:3},{value:"&#39;Fix&#39; keeper_test",id:"fix-keeper_test",level:3},{value:"Dependency Inject (v2)",id:"dependency-inject-v2",level:3},{value:"Fix app.go references",id:"fix-appgo-references",level:3},{value:"Module Core Logic",id:"module-core-logic",level:3},{value:"Implement the EndBlocker",id:"implement-the-endblocker",level:3},{value:"Test Deployment",id:"test-deployment",level:2},{value:"Start Testnet",id:"start-testnet",level:3},{value:"Upload Contract",id:"upload-contract",level:3},{value:"Instantiate our Contract",id:"instantiate-our-contract",level:3},{value:"Verify data",id:"verify-data",level:3},{value:"Write a review",id:"write-a-review",level:2},{value:"Verify the review",id:"verify-the-review",level:3},{value:"Write a review for a non-validator",id:"write-a-review-for-a-non-validator",level:3}],c={toc:d},p="wrapper";function g(e){let{components:t,...a}=e;return(0,n.yg)(p,(0,r.A)({},c,a,{components:t,mdxType:"MDXLayout"}),(0,n.yg)("h1",{id:"cosmwasm-validator-reviews"},"CosmWasm Validator Reviews"),(0,n.yg)("p",null,"You will build a new chain with ",(0,n.yg)("a",{parentName:"p",href:"https://cosmwasm.com"},"CosmWasm"),", enabling a proof-of-stake validator review system. You will write a contract to collect and manage validator reviews, integrate it with the chain, and update validator data automatically through the Cosmos-SDK endblocker module."),(0,n.yg)("p",null,"There are easy ways to get validators in a cosmwasm smart contract. The goal of this tutorial is to teach how to pass data from the SDK to a contract."),(0,n.yg)("h2",{id:"prerequisites"},"Prerequisites"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"/dev-portal-docsite/onboarding/install/system-setup"},"System Setup")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"/dev-portal-docsite/onboarding/install/install-spawn"},"Install Spawn")),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("a",{parentName:"li",href:"/dev-portal-docsite/onboarding/install/system-setup"},"Rust + CosmWasm"))),(0,n.yg)("h2",{id:"setup-the-chain"},"Setup the Chain"),(0,n.yg)("p",null,"Build a new blockchain with CosmWasm enabled. THen generate a new module from the template for the reviews."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"GITHUB_USERNAME=rollchains\n\nspawn new rollchain \\\n--consensus=proof-of-stake \\\n--bech32=roll \\\n--denom=uroll \\\n--bin=rolld \\\n--disabled=block-explorer \\\n--org=${GITHUB_USERNAME}\n\n\n# move into the chain directory\ncd rollchain\n\n# Generate the reviews module\nspawn module new reviews\n\n# build the proto to code\nmake proto-gen\n")),(0,n.yg)("p",null,"Once the chain is started, continue on to the contract building steps"),(0,n.yg)("h2",{id:"cosmwasm-build-contract"},"CosmWasm Build Contract"),(0,n.yg)("p",null,"CosmWasm has a template repository that is used to generate new contracts. A minimal contract will be built with the ",(0,n.yg)("inlineCode",{parentName:"p"},"validator-reviews-contract")," name provided on a specific commit."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"cargo generate --git https://github.com/CosmWasm/cw-template.git \\\n    --name validator-reviews-contract \\\n    -d minimal=true --tag a2a169164324aa1b48ab76dd630f75f504e41d99\n")),(0,n.yg)("p",null,"A new folder will be created with the contract template."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"code validator-reviews-contract/\n")),(0,n.yg)("h3",{id:"set-state"},"Set State"),(0,n.yg)("p",null,"The contract state and base structure is set in the state.rs file. There are 2 groups of data that must be managed, validators and the reviews for validators."),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Validators")," have unique addresses and name stored on the chain. This data will be passed from the SDK to the contract."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Reviews")," will save a user wallets address and their text reviews for a validator.")),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/state.rs"',title:'"src/state.rs"'},'use std::collections::BTreeMap;\n\nuse cosmwasm_schema::cw_serde;\nuse cw_storage_plus::{Item, Map};\n\n#[cw_serde]\npub struct Validator {\n    pub address: String,\n    pub moniker: String,\n}\npub const VALIDATORS: Item<Vec<Validator>> = Item::new("validators");\n\n// user -> text\npub type Reviews = BTreeMap<String, String>;\n\n// validator_address -> reviews\npub const REVIEWS: Map<&str, Reviews> = Map::new("reviews");\n')),(0,n.yg)("h3",{id:"set-inputs"},"Set Inputs"),(0,n.yg)("p",null,"By default contracts get 3 messages, ",(0,n.yg)("inlineCode",{parentName:"p"},"InstantiateMsg"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"ExecuteMsg"),", and ",(0,n.yg)("inlineCode",{parentName:"p"},"QueryMsg"),"."),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("strong",{parentName:"li"},"Instantiate")," allows initial contracts setup with a configuration desired. This is not used for us. Keep it empty."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("strong",{parentName:"li"},"Execute")," is where the main logic of the contract is. Add a ",(0,n.yg)("inlineCode",{parentName:"li"},"WriteReview")," message to allow users to write reviews. The user must know who they want to write a review for and what it says."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("strong",{parentName:"li"},"Query")," is for reading data from the contract. Add 2 queries, one to get all validators available and one to get reviews for a specific validator.")),(0,n.yg)("p",null,"The ",(0,n.yg)("inlineCode",{parentName:"p"},"SudoMsg")," is a default type not typically used. ",(0,n.yg)("inlineCode",{parentName:"p"},"Sudo")," stands for ",(0,n.yg)("inlineCode",{parentName:"p"},"Super User DO")," where the super user is the chain. ",(0,n.yg)("strong",{parentName:"p"},"Only")," the chain can submit data to this message type. A ",(0,n.yg)("inlineCode",{parentName:"p"},"SetValidators")," message is added to allow the chain to update the validators list within the contract. This is the pass through from the SDK to the contract."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/msg.rs"',title:'"src/msg.rs"'},"use cosmwasm_schema::{cw_serde, QueryResponses};\n\n#[cw_serde]\npub struct InstantiateMsg {}\n\n#[cw_serde]\npub enum ExecuteMsg {\n    // highlight-next-line\n    WriteReview { val_addr: String, review: String },\n}\n\n#[cw_serde]\n#[derive(QueryResponses)]\npub enum QueryMsg {\n    // highlight-start\n    #[returns(Vec<crate::state::Validator>)]\n    Validators {},\n\n    #[returns(crate::state::Reviews)]\n    Reviews { address: String },\n    // highlight-end\n}\n\n// highlight-start\n#[cw_serde]\npub enum SudoMsg {\n    SetValidators {\n        validators: Vec<crate::state::Validator>,\n    },\n}\n// highlight-end\n")),(0,n.yg)("h3",{id:"set-new-error"},"Set new error"),(0,n.yg)("p",null,"For a better experience, a new error is added to the contract. This will be used when a validator is not found in the list of validators. Users should not be allowed to post reviews for non existent validators."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/error.rs"',title:'"src/error.rs"'},'use cosmwasm_std::StdError;\nuse thiserror::Error;\n\n#[derive(Error, Debug)]\npub enum ContractError {\n    #[error("{0}")]\n    Std(#[from] StdError),\n\n    #[error("Unauthorized")]\n    Unauthorized {},\n\n    // Add any other custom errors you like here.\n    // Look at https://docs.rs/thiserror/1.0.21/thiserror/ for details.\n    // highlight-start\n    #[error("The validator is not found")]\n    NoValidatorFound {},\n    // highlight-end\n}\n')),(0,n.yg)("h3",{id:"imports"},"Imports"),(0,n.yg)("p",null,"The imports required for this next section are provided here. Paste these at the top of the file to get syntax highlighting."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/contract.rs"',title:'"src/contract.rs"'},"// highlight-start\nuse crate::state::{Reviews, REVIEWS, VALIDATORS};\nuse cosmwasm_std::to_json_binary;\nuse std::collections::BTreeMap;\n// highlight-end\n")),(0,n.yg)("h3",{id:"modify-instantiate-message"},"Modify Instantiate Message"),(0,n.yg)("p",null,"Even though no extra data is passed through to the setup method, an empty list of validators is saved to storage. This way if we try to get validators from the contract ",(0,n.yg)("strong",{parentName:"p"},"before")," any have been set by the chain, it returns nothing instead of an error."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/contract.rs"',title:'"src/contract.rs"'},'#[cfg_attr(not(feature = "library"), entry_point)]\npub fn instantiate(\n    // highlight-next-line\n    deps: DepsMut, // removes the underscore\n    _env: Env,\n    _info: MessageInfo,\n    _msg: InstantiateMsg,\n) -> Result<Response, ContractError> {\n    // highlight-start\n    VALIDATORS.save(deps.storage, &Vec::new())?;\n    Ok(Response::default())\n    // highlight-end\n}\n')),(0,n.yg)("h3",{id:"add-execute-logic"},"Add Execute Logic"),(0,n.yg)("p",null,"When the user sends a message, the contract needs to first check if the validator exist. It does this by loading the validators state and looping through all the validators to see if the one the user requested if in the list. If it is not, it returns to the user that the validator is not found. If it is found then the contract loads all reviews a validator has. If there are none, it creates an empty list of reviews since this will be the first one. The user's review is then added to the list and saved back to storage."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/contract.rs"',title:'"src/contract.rs"'},'#[cfg_attr(not(feature = "library"), entry_point)]\npub fn execute(\n    // highlight-next-line\n    deps: DepsMut, // removes the underscore\n    _env: Env,\n    _info: MessageInfo,\n    // highlight-next-line\n    msg: ExecuteMsg,  // removes the underscore\n) -> Result<Response, ContractError> {\n    // highlight-start\n    match msg {\n        ExecuteMsg::WriteReview { val_addr, review } => {\n            let active_validators = VALIDATORS.load(deps.storage)?;\n            if active_validators.iter().find(|v| v.address == val_addr).is_none() {\n                return Err(ContractError::NoValidatorFound {});\n            }\n\n            // Get current validator reviews if any. If there are none, create a new empty review map.\n            let mut all_revs: Reviews = match REVIEWS.may_load(deps.storage, &val_addr) {\n                Ok(Some(rev)) => rev,\n                _ => BTreeMap::new(),\n            };\n\n            // Set this users review for the validator.\n            all_revs.insert(val_addr.clone(), review);\n\n            // Save the updated reviews\n            REVIEWS.save(deps.storage, &val_addr, &all_revs)?;\n        }\n    }\n\n    Ok(Response::default())\n    // highlight-end\n}\n')),(0,n.yg)("h3",{id:"add-queries"},"Add Queries"),(0,n.yg)("p",null,"It is only useful to set reviews if you can also get them back. The first query for ",(0,n.yg)("inlineCode",{parentName:"p"},"Validators")," is just a helper method so users can see who they are allowed to review. The second query is for ",(0,n.yg)("inlineCode",{parentName:"p"},"Reviews")," and takes a validator address as a parameter. This will return all reviews for that validator."),(0,n.yg)("p",null,"To get reviews for all validators, a user would need to query ",(0,n.yg)("inlineCode",{parentName:"p"},"Validators"),", then iterate through all the addresses and query ",(0,n.yg)("inlineCode",{parentName:"p"},"Reviews")," for each one."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/contract.rs"',title:'"src/contract.rs"'},'#[cfg_attr(not(feature = "library"), entry_point)]\n// highlight-start\npub fn query(deps: Deps, _env: Env, msg: QueryMsg) -> StdResult<Binary> {\n    // note: ^^ deps & msg are not underscored ^^\n    match msg {\n        QueryMsg::Validators {} => {\n            let validators = VALIDATORS.load(deps.storage)?;\n            Ok(to_json_binary(&validators)?)\n        }\n        QueryMsg::Reviews { address } => {\n            let reviews = REVIEWS.load(deps.storage, &address)?;\n            Ok(to_json_binary(&reviews)?)\n        }\n    }\n// highlight-end\n}\n')),(0,n.yg)("h3",{id:"add-new-sudo-message-type"},"Add New Sudo Message Type"),(0,n.yg)("p",null,"The chain extended portion of this contract is now added. It is where the validator logic is actually set and saved to storage. As the validator set changes (nodes stop, new nodes come online), the chain will update the contract right away."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-rust",metastring:'title="src/contract.rs"',title:'"src/contract.rs"'},'// highlight-start\n// Insert at the bottom of the file\n#[cfg_attr(not(feature = "library"), entry_point)]\npub fn sudo(deps: DepsMut, _env: Env, msg: crate::msg::SudoMsg) -> Result<Response, ContractError> {\n    match msg {\n        crate::msg::SudoMsg::SetValidators { validators } => {\n            VALIDATORS.save(deps.storage, &validators)?;\n            Ok(Response::new())\n        }\n    }\n}\n// highlight-end\n')),(0,n.yg)("h3",{id:"build-the-contract"},"Build the Contract"),(0,n.yg)("p",null,"Build the contract to get the cosmwasm wasm binary. This converts it from english programming rust text to 0s and 1s that the chain can understand. The ",(0,n.yg)("inlineCode",{parentName:"p"},"optimize")," script requires docker to be installed and running. Make sure you followed the setup prerequisites at the top of the page and have the docker service or docker desktop installed."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"# run the build optimizer (from source -> contract wasm binary)\ncargo run-script optimize\n")),(0,n.yg)("p",null,"The .wasm file is then saved to ",(0,n.yg)("inlineCode",{parentName:"p"},"./artifacts/validator_reviews_contract.wasm"),"."),(0,n.yg)("h2",{id:"modify-the-module"},"Modify the Module"),(0,n.yg)("p",null,"The contract is complete but we need to pass the data into the contract from the chain. This is done through the sdk reviews module generated earlier. The module will be updated to include the wasm contract and the endblocker will be updated to pass the validator data to the contract."),(0,n.yg)("h3",{id:"setup-the-keeper"},"Setup the Keeper"),(0,n.yg)("p",null,"We must give our code access to other modules on the chain. The wasm module is required to interact with the contract. The staking module is required to get the list of validators. This keeper is the access point for all the specific logic."),(0,n.yg)("p",null,"Add the imports, keeper setup, and new keeper output."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="x/reviews/keeper.go"',title:'"x/reviews/keeper.go"'},'import (\n    ...\n\n    // highlight-start\n    wasmkeeper "github.com/CosmWasm/wasmd/x/wasm/keeper"\n    wasmtypes "github.com/CosmWasm/wasmd/x/wasm/types"\n    stakingkeeper "github.com/cosmos/cosmos-sdk/x/staking/keeper"\n    // highlight-end\n)\n\ntype Keeper struct\n    ...\n\n    // highlight-start\n    WasmKeeper     *wasmkeeper.Keeper\n    ContractKeeper wasmtypes.ContractOpsKeeper\n    StakingKeeper  *stakingkeeper.Keeper\n    // highlight-end\n}\n\nfunc NewKeeper(\n    ...\n    // highlight-start\n    wasmKeeper *wasmkeeper.Keeper, // since wasm may not be created yet.\n    stakingKeeper *stakingkeeper.Keeper,\n    // highlight-end\n    authority string,\n) Keeper {\n    ...\n\n    k := Keeper{\n        ...\n\n        // highlight-start\n        WasmKeeper:     wasmKeeper,\n        ContractKeeper: wasmkeeper.NewDefaultPermissionKeeper(wasmKeeper),\n        StakingKeeper:  stakingKeeper,\n        // highlight-end\n\n        authority: authority,\n    }\n}\n')),(0,n.yg)("h3",{id:"fix-keeper_test"},"'Fix' keeper_test"),(0,n.yg)("admonition",{title:"Warning",type:"note"},(0,n.yg)("p",{parentName:"admonition"},"Testing wasm requires significantly more setup for the test environment. For now, just add a blank reference here.")),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="x/reviews/keeper/keeper_test.go"',title:'"x/reviews/keeper/keeper_test.go"'},"func SetupTest(t *testing.T) *testFixture\n    ...\n\n    // Setup Keeper.\n    // highlight-next-line\n    f.k = keeper.NewKeeper(encCfg.Codec, runtime.NewKVStoreService(keys[types.StoreKey]), logger, &wasmkeeper.Keeper{}, f.stakingKeeper, f.govModAddr)\n}\n")),(0,n.yg)("h3",{id:"dependency-inject-v2"},"Dependency Inject (v2)"),(0,n.yg)("p",null,"Similar to the keeper_test issue, CosmWasm does not have support for SDK v2 depinject. This will be updated in the future. For now, set the keeper to nil and provide Staking reference. You do not need to know what this does. Just resolve the error on the line with a copy paste."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="x/reviews/depinject.go"',title:'"x/reviews/depinject.go"'},"func ProvideModule(in ModuleInputs) ModuleOutputs {\n    ...\n\n    // highlight-next-line\n    k := keeper.NewKeeper(in.Cdc, in.StoreService, log.NewLogger(os.Stderr), nil, &in.StakingKeeper, govAddr)\n}\n")),(0,n.yg)("h3",{id:"fix-appgo-references"},"Fix app.go references"),(0,n.yg)("p",null,"The main application needs the access to the wasm and staking logic as well. Fix the missing imports and add them in like so."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="app/app.go"',title:'"app/app.go"'},"    app.ReviewsKeeper = reviewskeeper.NewKeeper(\n        appCodec,\n        runtime.NewKVStoreService(keys[reviewstypes.StoreKey]),\n        logger,\n        // highlight-start\n        &app.WasmKeeper,\n        app.StakingKeeper,\n        // highlight-end\n        authtypes.NewModuleAddress(govtypes.ModuleName).String(),\n    )\n")),(0,n.yg)("p",null,"it is now time to use these modules and write the logic to pass data to the contract from the chain."),(0,n.yg)("h3",{id:"module-core-logic"},"Module Core Logic"),(0,n.yg)("p",null,"The CosmWasm contract requires data in a specific format. You can review this back in the ",(0,n.yg)("inlineCode",{parentName:"p"},"src/state.rs")," file. Since the chain only is passing validator data over, we need to convert this into Go code manually. The ",(0,n.yg)("inlineCode",{parentName:"p"},"Validator")," struct is created to match the contract. The CosmWasm contract expects a JSON formatted input. This input is put together with the ",(0,n.yg)("inlineCode",{parentName:"p"},"Formatted")," method on a list of validators. The chain could have just 1 validator, or several hundred. This method will convert them all into the correct format for the list we are to pass."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="x/reviews/module.go"',title:'"x/reviews/module.go"'},'// Add this below AppModule struct {\n\n// highlight-start\ntype Validator struct {\n    Address string `json:"address"`\n    Moniker string `json:"moniker"`\n}\n\ntype Validators []Validator\n\nfunc (vs Validators) Formatted() string {\n    output := ""\n    for _, val := range vs {\n        output += fmt.Sprintf(`{"address":"%s","moniker":"%s"},`, val.Address, val.Moniker)\n    }\n\n    // remove the trailing comma from the last output append.\n    return output[:len(output)-1]\n}\n// highlight-end\n')),(0,n.yg)("h3",{id:"implement-the-endblocker"},"Implement the EndBlocker"),(0,n.yg)("p",null,"To pass data we must first get the data. Using the ",(0,n.yg)("inlineCode",{parentName:"p"},"GetAllValidators")," method from the staking module, all validators are now accessible for the logic to use. Loop through these validators and only add the ones that are bonded (active) to the list of validators. If they are bonded, they are added to the list."),(0,n.yg)("p",null,"Once all validators have been processed the ",(0,n.yg)("inlineCode",{parentName:"p"},"endBlockSudoMsg")," gets them into the JSON format required. The format is out of scope but a high level overview"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"SetValidators")," in the code becomes ",(0,n.yg)("inlineCode",{parentName:"li"},"set_validators"),", called ",(0,n.yg)("a",{parentName:"li",href:"https://simple.wikipedia.org/wiki/Snake_case"},"snake case"),"."),(0,n.yg)("li",{parentName:"ul"},"The ",(0,n.yg)("inlineCode",{parentName:"li"},"SetValidators")," type in rust has the element called ",(0,n.yg)("inlineCode",{parentName:"li"},"validators")," which is an array of ",(0,n.yg)("inlineCode",{parentName:"li"},"Validator")," objects. This is the ",(0,n.yg)("inlineCode",{parentName:"li"},"validators")," array in the JSON."),(0,n.yg)("li",{parentName:"ul"},"Each ",(0,n.yg)("inlineCode",{parentName:"li"},"Validator")," object has an ",(0,n.yg)("inlineCode",{parentName:"li"},"address")," and ",(0,n.yg)("inlineCode",{parentName:"li"},"moniker")," field. These are the ",(0,n.yg)("inlineCode",{parentName:"li"},"address")," and ",(0,n.yg)("inlineCode",{parentName:"li"},"moniker")," fields in the JSON, called from the Formatted() method.")),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-go",metastring:'title="x/reviews/module.go"',title:'"x/reviews/module.go"'},'// Paste this anywhere within the file\n// highlight-start\nfunc (am AppModule) EndBlock(ctx context.Context) error {\n    stakingVals, err := am.keeper.StakingKeeper.GetAllValidators(ctx)\n    if err != nil {\n        return err\n    }\n\n    validators := Validators{}\n    for _, val := range stakingVals {\n        // if it is not active, skip it\n        if !val.IsBonded() {\n            continue\n        }\n\n        validators = append(validators, Validator{\n            Address: val.OperatorAddress,\n            Moniker: val.Description.Moniker,\n        })\n    }\n\n    // The first contract created from acc0\n    addr := "roll14hj2tavq8fpesdwxxcu44rty3hh90vhujrvcmstl4zr3txmfvw9sjczpjh"\n    contract := sdk.MustAccAddressFromBech32(addr)\n\n    // SudoMsg format for the contract input.\n    // example: {"set_validators":{"validators":[{"address":"ADDRESS","moniker": "NAME"}]}}\n    endBlockSudoMsg := fmt.Sprintf(`{"set_validators":{"validators":[%s]}}`, validators.Formatted())\n    fmt.Println("EndBlockSudoMessage Format:", endBlockSudoMsg)\n\n    // When the network first starts up there is no contract to execute against (until uploaded)\n    // This returns an error but is expected behavior initially.\n    // You can not return errors in the EndBlocker as it is not a transaction. It will halt the network.\n    //\n    // This is why the error is only printed to the logs and not returned.\n    //\n    // A more proper solution would set the contract via a SDK message after it is uploaded.\n    // This is out of scope for this tutorial, but a future challenge for you.\n    res, err := am.keeper.ContractKeeper.Sudo(sdk.UnwrapSDKContext(ctx), contract, []byte(endBlockSudoMsg))\n    if err != nil {\n        fmt.Println("EndBlockSudoResult", res)\n        fmt.Println("EndBlockSudoError", err)\n    }\n\n    return nil\n}\n// highlight-end\n')),(0,n.yg)("h2",{id:"test-deployment"},"Test Deployment"),(0,n.yg)("h3",{id:"start-testnet"},"Start Testnet"),(0,n.yg)("p",null,"Begin the CosmWasm testnet with the custom EndBlocker logic. You will see errors every block. This is expected and is explained in the EndBlock code why this is the case."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"make sh-testnet\n")),(0,n.yg)("h3",{id:"upload-contract"},"Upload Contract"),(0,n.yg)("p",null,"Make sure you are in the ",(0,n.yg)("inlineCode",{parentName:"p"},"rollchain")," directory to begin interacting and uploading the contract to the chain."),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"CONTRACT_SOURCE=./validator-reviews-contract/artifacts/validator_reviews_contract.wasm\nrolld tx wasm store $CONTRACT_SOURCE --from=acc0 --gas=auto --gas-adjustment=2.0 --yes\n# rolld q wasm list-code\n")),(0,n.yg)("h3",{id:"instantiate-our-contract"},"Instantiate our Contract"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"rolld tx wasm instantiate 1 '{}' --no-admin --from=acc0 --label=\"reviews\" \\\n    --gas=auto --gas-adjustment=2.0 --yes\n\nrolld q wasm list-contracts-by-creator roll1hj5fveer5cjtn4wd6wstzugjfdxzl0xpg2te87\n\nREVIEWS_CONTRACT=roll14hj2tavq8fpesdwxxcu44rty3hh90vhujrvcmstl4zr3txmfvw9sjczpjh\n")),(0,n.yg)("h3",{id:"verify-data"},"Verify data"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},"rolld q wasm state smart $REVIEWS_CONTRACT '{\"validators\":{}}'\n")),(0,n.yg)("h2",{id:"write-a-review"},"Write a review"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},'MESSAGE=\'{"write_review":{"val_addr":"rollvaloper1hj5fveer5cjtn4wd6wstzugjfdxzl0xpmhf3p6","review":"hi reviewing."}}\'\nrolld tx wasm execute $REVIEWS_CONTRACT "$MESSAGE" --from=acc0 \\\n    --gas=auto --gas-adjustment=2.0 --yes\n')),(0,n.yg)("h3",{id:"verify-the-review"},"Verify the review"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},'rolld q wasm state smart $REVIEWS_CONTRACT \'{"reviews":{"address":"rollvaloper1hj5fveer5cjtn4wd6wstzugjfdxzl0xpmhf3p6"}}\'\n')),(0,n.yg)("h3",{id:"write-a-review-for-a-non-validator"},"Write a review for a non-validator"),(0,n.yg)("pre",null,(0,n.yg)("code",{parentName:"pre",className:"language-bash"},'MESSAGE=\'{"write_review":{"val_addr":"NotAValidator","review":"hi this is a review"}}\'\n\nrolld tx wasm execute $REVIEWS_CONTRACT "$MESSAGE" --from=acc0 \\\n    --gas=auto --gas-adjustment=2.0 --yes\n')))}g.isMDXComponent=!0}}]);