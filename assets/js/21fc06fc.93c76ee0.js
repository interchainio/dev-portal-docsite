"use strict";(self.webpackChunkdev_portal_docsite=self.webpackChunkdev_portal_docsite||[]).push([[1006],{15680:(e,n,a)=>{a.d(n,{xA:()=>m,yg:()=>u});var t=a(96540);function i(e,n,a){return n in e?Object.defineProperty(e,n,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[n]=a,e}function o(e,n){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);n&&(t=t.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),a.push.apply(a,t)}return a}function s(e){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?o(Object(a),!0).forEach((function(n){i(e,n,a[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(a,n))}))}return e}function r(e,n){if(null==e)return{};var a,t,i=function(e,n){if(null==e)return{};var a,t,i={},o=Object.keys(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||(i[a]=e[a]);return i}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(t=0;t<o.length;t++)a=o[t],n.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var l=t.createContext({}),d=function(e){var n=t.useContext(l),a=n;return e&&(a="function"==typeof e?e(n):s(s({},n),e)),a},m=function(e){var n=d(e.components);return t.createElement(l.Provider,{value:n},e.children)},p="mdxType",g={inlineCode:"code",wrapper:function(e){var n=e.children;return t.createElement(t.Fragment,{},n)}},c=t.forwardRef((function(e,n){var a=e.components,i=e.mdxType,o=e.originalType,l=e.parentName,m=r(e,["components","mdxType","originalType","parentName"]),p=d(a),c=i,u=p["".concat(l,".").concat(c)]||p[c]||g[c]||o;return a?t.createElement(u,s(s({ref:n},m),{},{components:a})):t.createElement(u,s({ref:n},m))}));function u(e,n){var a=arguments,i=n&&n.mdxType;if("string"==typeof e||i){var o=a.length,s=new Array(o);s[0]=c;var r={};for(var l in n)hasOwnProperty.call(n,l)&&(r[l]=n[l]);r.originalType=e,r[p]="string"==typeof e?e:i,s[1]=r;for(var d=2;d<o;d++)s[d]=a[d];return t.createElement.apply(null,s)}return t.createElement.apply(null,a)}c.displayName="MDXCreateElement"},74907:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>s,default:()=>g,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var t=a(58168),i=(a(96540),a(15680));const o={sidebar_position:1},s="Gas and Fees",r={unversionedId:"learn/beginner/gas-fees",id:"version-0.52/learn/beginner/gas-fees",title:"Gas and Fees",description:"This document describes the default strategies to handle gas and fees within a Cosmos SDK application.",source:"@site/cosmos-sdk_versioned_docs/version-0.52/learn/beginner/04-gas-fees.md",sourceDirName:"learn/beginner",slug:"/learn/beginner/gas-fees",permalink:"/dev-portal-docsite/cosmos-sdk/learn/beginner/gas-fees",draft:!1,tags:[],version:"0.52",sidebarPosition:1,frontMatter:{sidebar_position:1},sidebar:"learnSidebar",previous:{title:"Accounts",permalink:"/dev-portal-docsite/cosmos-sdk/learn/beginner/accounts"},next:{title:"BaseApp",permalink:"/dev-portal-docsite/cosmos-sdk/learn/advanced/baseapp"}},l={},d=[{value:"Introduction to <code>Gas</code> and <code>Fees</code>",id:"introduction-to-gas-and-fees",level:2},{value:"Gas Meter",id:"gas-meter",level:2},{value:"Main Gas Meter",id:"main-gas-meter",level:3},{value:"Block Gas Meter",id:"block-gas-meter",level:3},{value:"AnteHandler",id:"antehandler",level:2}],m={toc:d},p="wrapper";function g(e){let{components:n,...a}=e;return(0,i.yg)(p,(0,t.A)({},m,a,{components:n,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"gas-and-fees"},"Gas and Fees"),(0,i.yg)("admonition",{title:"Synopsis",type:"note"},(0,i.yg)("p",{parentName:"admonition"},"This document describes the default strategies to handle gas and fees within a Cosmos SDK application.")),(0,i.yg)("admonition",{title:"Pre-requisite Readings",type:"note"},(0,i.yg)("ul",{parentName:"admonition"},(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("a",{parentName:"li",href:"/dev-portal-docsite/cosmos-sdk/learn/beginner/app-anatomy"},"Anatomy of a Cosmos SDK Application")))),(0,i.yg)("h2",{id:"introduction-to-gas-and-fees"},"Introduction to ",(0,i.yg)("inlineCode",{parentName:"h2"},"Gas")," and ",(0,i.yg)("inlineCode",{parentName:"h2"},"Fees")),(0,i.yg)("p",null,"In the Cosmos SDK, ",(0,i.yg)("inlineCode",{parentName:"p"},"gas")," is a special unit that is used to track the consumption of resources during execution. ",(0,i.yg)("inlineCode",{parentName:"p"},"gas")," is typically consumed whenever reads and writes are made to the store, but it can also be consumed if expensive computation needs to be done. It serves two main purposes:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Make sure blocks are not consuming too many resources and are finalized. This is implemented by default in the Cosmos SDK via the ",(0,i.yg)("a",{parentName:"li",href:"#block-gas-meter"},"block gas meter"),"."),(0,i.yg)("li",{parentName:"ul"},"Prevent spam and abuse from end-users. To this end, ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," consumed during ",(0,i.yg)("a",{parentName:"li",href:"/dev-portal-docsite/cosmos-sdk/build/building-modules/messages-and-queries#messages"},(0,i.yg)("inlineCode",{parentName:"a"},"message"))," execution is typically priced, resulting in a ",(0,i.yg)("inlineCode",{parentName:"li"},"fee")," (",(0,i.yg)("inlineCode",{parentName:"li"},"fees = gas * gas-prices"),"). ",(0,i.yg)("inlineCode",{parentName:"li"},"fees")," generally have to be paid by the sender of the ",(0,i.yg)("inlineCode",{parentName:"li"},"message"),". Note that the Cosmos SDK does not enforce ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," pricing by default, as there may be other ways to prevent spam (e.g. bandwidth schemes). Still, most applications implement ",(0,i.yg)("inlineCode",{parentName:"li"},"fee")," mechanisms to prevent spam by using the ",(0,i.yg)("a",{parentName:"li",href:"#antehandler"},(0,i.yg)("inlineCode",{parentName:"a"},"AnteHandler")),".")),(0,i.yg)("h2",{id:"gas-meter"},"Gas Meter"),(0,i.yg)("p",null,"In the Cosmos SDK, ",(0,i.yg)("inlineCode",{parentName:"p"},"gas")," is a simple alias for ",(0,i.yg)("inlineCode",{parentName:"p"},"uint64"),", and is managed by an object called a ",(0,i.yg)("em",{parentName:"p"},"gas meter"),". Gas meters implement the ",(0,i.yg)("inlineCode",{parentName:"p"},"GasMeter")," interface"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-go",metastring:"reference",reference:!0},"https://github.com/cosmos/cosmos-sdk/blob/b795646/store/types/gas.go#L40-L51\n")),(0,i.yg)("p",null,"where:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"GasConsumed()")," returns the amount of gas that was consumed by the gas meter instance."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"GasConsumedToLimit()")," returns the amount of gas that was consumed by gas meter instance, or the limit if it is reached."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"GasRemaining()")," returns the gas left in the GasMeter."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"Limit()")," returns the limit of the gas meter instance. ",(0,i.yg)("inlineCode",{parentName:"li"},"0")," if the gas meter is infinite."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"ConsumeGas(amount Gas, descriptor string)")," consumes the amount of ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," provided. If the ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," overflows, it panics with the ",(0,i.yg)("inlineCode",{parentName:"li"},"descriptor")," message. If the gas meter is not infinite, it panics if ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," consumed goes above the limit."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"RefundGas()")," deducts the given amount from the gas consumed. This functionality enables refunding gas to the transaction or block gas pools so that EVM-compatible chains can fully support the go-ethereum StateDB interface."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"IsPastLimit()")," returns ",(0,i.yg)("inlineCode",{parentName:"li"},"true")," if the amount of gas consumed by the gas meter instance is strictly above the limit, ",(0,i.yg)("inlineCode",{parentName:"li"},"false")," otherwise."),(0,i.yg)("li",{parentName:"ul"},(0,i.yg)("inlineCode",{parentName:"li"},"IsOutOfGas()")," returns ",(0,i.yg)("inlineCode",{parentName:"li"},"true")," if the amount of gas consumed by the gas meter instance is above or equal to the limit, ",(0,i.yg)("inlineCode",{parentName:"li"},"false")," otherwise.")),(0,i.yg)("p",null,"The gas meter is held under the ",(0,i.yg)("inlineCode",{parentName:"p"},"GasMeterService")," in ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/learn/advanced/core"},(0,i.yg)("inlineCode",{parentName:"a"},"Environment")),", and consuming gas is done with the following pattern:"),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},"The gas.Service does not give access to all the methods of the gas meter.")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-go"},'environment.GasMeter(ctx).Consume(amount, "description")\n')),(0,i.yg)("p",null,"By default, the Cosmos SDK makes use of two different gas meters, the ",(0,i.yg)("a",{parentName:"p",href:"#main-gas-meter"},"main gas meter")," and the ",(0,i.yg)("a",{parentName:"p",href:"#block-gas-meter"},"block gas meter"),"."),(0,i.yg)("h3",{id:"main-gas-meter"},"Main Gas Meter"),(0,i.yg)("p",null,"The main gas meter is initialized in ",(0,i.yg)("inlineCode",{parentName:"p"},"FinalizeBlock")," via ",(0,i.yg)("inlineCode",{parentName:"p"},"setFinalizeBlockState"),", and then tracks gas consumption during execution sequences that lead to state-transitions, i.e. those originally triggered by ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/learn/advanced/baseapp#finalizeblock"},(0,i.yg)("inlineCode",{parentName:"a"},"FinalizeBlock")),". At the beginning of each transaction execution, the main gas meter ",(0,i.yg)("strong",{parentName:"p"},"must be set to 0")," in the ",(0,i.yg)("a",{parentName:"p",href:"#antehandler"},(0,i.yg)("inlineCode",{parentName:"a"},"AnteHandler")),", so that it can track gas consumption per-transaction."),(0,i.yg)("p",null,"Gas consumption can be done manually, generally by the module developer in the ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/build/building-modules/preblock-beginblock-endblock"},(0,i.yg)("inlineCode",{parentName:"a"},"BeginBlocker"),", ",(0,i.yg)("inlineCode",{parentName:"a"},"EndBlocker"))," or ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/build/building-modules/msg-services"},(0,i.yg)("inlineCode",{parentName:"a"},"Msg")," service"),", but most of the time it is done automatically whenever there is a read or write to the store. This automatic gas consumption logic is implemented in a special store called ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/learn/advanced/store#gaskv-store"},(0,i.yg)("inlineCode",{parentName:"a"},"GasKv")),"."),(0,i.yg)("h3",{id:"block-gas-meter"},"Block Gas Meter"),(0,i.yg)("p",null,(0,i.yg)("inlineCode",{parentName:"p"},"ctx.BlockGasMeter()")," is the gas meter used to track gas consumption per block and make sure it does not go above a certain limit. "),(0,i.yg)("p",null,"During the genesis phase, gas consumption is unlimited to accommodate initialisation transactions. "),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-go"},"app.finalizeBlockState.SetContext(app.finalizeBlockState.Context().WithBlockGasMeter(storetypes.NewInfiniteGasMeter()))\n")),(0,i.yg)("p",null,"Following the genesis block, the block gas meter is set to a finite value by the SDK. This transition is facilitated by the consensus engine (e.g., CometBFT) calling the ",(0,i.yg)("inlineCode",{parentName:"p"},"RequestFinalizeBlock")," function, which in turn triggers the SDK's ",(0,i.yg)("inlineCode",{parentName:"p"},"FinalizeBlock")," method. Within ",(0,i.yg)("inlineCode",{parentName:"p"},"FinalizeBlock"),", ",(0,i.yg)("inlineCode",{parentName:"p"},"internalFinalizeBlock")," is executed, performing necessary state updates and function executions. The block gas meter, initialised each with a finite limit, is then incorporated into the context for transaction execution, ensuring gas consumption does not exceed the block's gas limit and is reset at the end of each block."),(0,i.yg)("p",null,"Modules within the Cosmos SDK can consume block gas at any point during their execution by utilising the ",(0,i.yg)("inlineCode",{parentName:"p"},"ctx"),". This gas consumption primarily occurs during state read/write operations and transaction processing. The block gas meter, accessible via ",(0,i.yg)("inlineCode",{parentName:"p"},"ctx.BlockGasMeter()"),", monitors the total gas usage within a block, enforcing the gas limit to prevent excessive computation. This ensures that gas limits are adhered to on a per-block basis, starting from the first block post-genesis."),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-go"},"gasMeter := app.getBlockGasMeter(app.finalizeBlockState.Context())\napp.finalizeBlockState.SetContext(app.finalizeBlockState.Context().WithBlockGasMeter(gasMeter))\n")),(0,i.yg)("p",null,"This above shows the general mechanism for setting the block gas meter with a finite limit based on the block's consensus parameters."),(0,i.yg)("h2",{id:"antehandler"},"AnteHandler"),(0,i.yg)("p",null,"The ",(0,i.yg)("inlineCode",{parentName:"p"},"AnteHandler")," is run for every transaction during ",(0,i.yg)("inlineCode",{parentName:"p"},"CheckTx")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"FinalizeBlock"),", before a Protobuf ",(0,i.yg)("inlineCode",{parentName:"p"},"Msg")," service method for each ",(0,i.yg)("inlineCode",{parentName:"p"},"sdk.Msg")," in the transaction. "),(0,i.yg)("p",null,"The anteHandler is not implemented in the core Cosmos SDK but in a module. That said, most applications today use the default implementation defined in the ",(0,i.yg)("a",{parentName:"p",href:"https://github.com/cosmos/cosmos-sdk/tree/main/x/auth"},(0,i.yg)("inlineCode",{parentName:"a"},"auth")," module"),". Here is what the ",(0,i.yg)("inlineCode",{parentName:"p"},"anteHandler")," is intended to do in a normal Cosmos SDK application:"),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Verify that the transactions are of the correct type. Transaction types are defined in the module that implements the ",(0,i.yg)("inlineCode",{parentName:"li"},"anteHandler"),", and they follow the transaction interface:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-go",metastring:"reference",reference:!0},"https://github.com/cosmos/cosmos-sdk/blob/v0.52.0-beta.2/types/tx_msg.go#L53-L66\n")),(0,i.yg)("p",null,"  This enables developers to play with various types for the transaction of their application. In the default ",(0,i.yg)("inlineCode",{parentName:"p"},"auth")," module, the default transaction type is ",(0,i.yg)("inlineCode",{parentName:"p"},"Tx"),": "),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-protobuf",metastring:"reference",reference:!0},"https://github.com/cosmos/cosmos-sdk/blob/v0.52.0-beta.2/proto/cosmos/tx/v1beta1/tx.proto#L15-L28\n")),(0,i.yg)("ul",null,(0,i.yg)("li",{parentName:"ul"},"Verify signatures for each ",(0,i.yg)("a",{parentName:"li",href:"/dev-portal-docsite/cosmos-sdk/build/building-modules/messages-and-queries#messages"},(0,i.yg)("inlineCode",{parentName:"a"},"message"))," contained in the transaction. Each ",(0,i.yg)("inlineCode",{parentName:"li"},"message")," should be signed by one or multiple sender(s), and these signatures must be verified in the ",(0,i.yg)("inlineCode",{parentName:"li"},"anteHandler"),"."),(0,i.yg)("li",{parentName:"ul"},"During ",(0,i.yg)("inlineCode",{parentName:"li"},"CheckTx"),", verify that the gas prices provided with the transaction are greater than the local ",(0,i.yg)("inlineCode",{parentName:"li"},"min-gas-prices")," (as a reminder, gas-prices can be deduced from the following equation: ",(0,i.yg)("inlineCode",{parentName:"li"},"fees = gas * gas-prices"),"). ",(0,i.yg)("inlineCode",{parentName:"li"},"min-gas-prices")," is a parameter local to each full-node and used during ",(0,i.yg)("inlineCode",{parentName:"li"},"CheckTx")," to discard transactions that do not provide a minimum amount of fees. This ensures that the mempool cannot be spammed with garbage transactions."),(0,i.yg)("li",{parentName:"ul"},"Verify that the sender of the transaction has enough funds to cover for the ",(0,i.yg)("inlineCode",{parentName:"li"},"fees"),". When the end-user generates a transaction, they must indicate 2 of the 3 following parameters (the third one being implicit): ",(0,i.yg)("inlineCode",{parentName:"li"},"fees"),", ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," and ",(0,i.yg)("inlineCode",{parentName:"li"},"gas-prices"),". This signals how much they are willing to pay for nodes to execute their transaction. The provided ",(0,i.yg)("inlineCode",{parentName:"li"},"gas")," value is stored in a parameter called ",(0,i.yg)("inlineCode",{parentName:"li"},"GasWanted")," for later use."),(0,i.yg)("li",{parentName:"ul"},"Set ",(0,i.yg)("inlineCode",{parentName:"li"},"newCtx.GasMeter")," to 0, with a limit of ",(0,i.yg)("inlineCode",{parentName:"li"},"GasWanted"),". ",(0,i.yg)("strong",{parentName:"li"},"This step is crucial"),", as it not only makes sure the transaction cannot consume infinite gas, but also that ",(0,i.yg)("inlineCode",{parentName:"li"},"ctx.GasMeter")," is reset in-between each transaction (",(0,i.yg)("inlineCode",{parentName:"li"},"ctx")," is set to ",(0,i.yg)("inlineCode",{parentName:"li"},"newCtx")," after ",(0,i.yg)("inlineCode",{parentName:"li"},"anteHandler")," is run, and the ",(0,i.yg)("inlineCode",{parentName:"li"},"anteHandler")," is run each time a transactions executes).")),(0,i.yg)("p",null,"As explained above, the ",(0,i.yg)("inlineCode",{parentName:"p"},"anteHandler")," returns a maximum limit of ",(0,i.yg)("inlineCode",{parentName:"p"},"gas")," the transaction can consume during execution called ",(0,i.yg)("inlineCode",{parentName:"p"},"GasWanted"),". The actual amount consumed in the end is denominated ",(0,i.yg)("inlineCode",{parentName:"p"},"GasUsed"),", and we must therefore have ",(0,i.yg)("inlineCode",{parentName:"p"},"GasUsed <= GasWanted"),". Both ",(0,i.yg)("inlineCode",{parentName:"p"},"GasWanted")," and ",(0,i.yg)("inlineCode",{parentName:"p"},"GasUsed")," are relayed to the underlying consensus engine when ",(0,i.yg)("a",{parentName:"p",href:"/dev-portal-docsite/cosmos-sdk/learn/advanced/baseapp#finalizeblock"},(0,i.yg)("inlineCode",{parentName:"a"},"FinalizeBlock"))," returns."))}g.isMDXComponent=!0}}]);