"use strict";(self.webpackChunkdev_portal_docsite=self.webpackChunkdev_portal_docsite||[]).push([[6517],{15680:(e,t,n)=>{n.d(t,{xA:()=>p,yg:()=>h});var i=n(96540);function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){a(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,i,a=function(e,t){if(null==e)return{};var n,i,a={},o=Object.keys(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)n=o[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var s=i.createContext({}),d=function(e){var t=i.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},p=function(e){var t=d(e.components);return i.createElement(s.Provider,{value:t},e.children)},c="mdxType",g={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},u=i.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),c=d(n),u=a,h=c["".concat(s,".").concat(u)]||c[u]||g[u]||o;return n?i.createElement(h,r(r({ref:t},p),{},{components:n})):i.createElement(h,r({ref:t},p))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l[c]="string"==typeof e?e:a,r[1]=l;for(var d=2;d<o;d++)r[d]=n[d];return i.createElement.apply(null,r)}return i.createElement.apply(null,n)}u.displayName="MDXCreateElement"},77818:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>s,contentTitle:()=>r,default:()=>g,frontMatter:()=>o,metadata:()=>l,toc:()=>d});var i=n(58168),a=(n(96540),n(15680));const o={title:"Handling Updates and Misbehaviour",sidebar_label:"Handling Updates and Misbehaviour",sidebar_position:5,slug:"/ibc/light-clients/updates-and-misbehaviour"},r="Handling ClientMessages: updates and misbehaviour",l={unversionedId:"docs/light-clients/developer-guide/updates-and-misbehaviour",id:"docs/light-clients/developer-guide/updates-and-misbehaviour",title:"Handling Updates and Misbehaviour",description:"As mentioned before in the documentation about implementing the ConsensusState interface, ClientMessage is an interface used to update an IBC client. This update may be performed by:",source:"@site/ibc-go/docs/03-light-clients/01-developer-guide/05-updates-and-misbehaviour.md",sourceDirName:"docs/03-light-clients/01-developer-guide",slug:"/ibc/light-clients/updates-and-misbehaviour",permalink:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/updates-and-misbehaviour",draft:!1,tags:[],version:"current",sidebarPosition:5,frontMatter:{title:"Handling Updates and Misbehaviour",sidebar_label:"Handling Updates and Misbehaviour",sidebar_position:5,slug:"/ibc/light-clients/updates-and-misbehaviour"},sidebar:"defaultSidebar",previous:{title:"Consensus State interface",permalink:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/consensus-state"},next:{title:"Handling Upgrades",permalink:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/upgrades"}},s={},d=[{value:"Implementing the <code>ClientMessage</code> interface",id:"implementing-the-clientmessage-interface",level:2},{value:"Handling updates and misbehaviour",id:"handling-updates-and-misbehaviour",level:2},{value:"<code>VerifyClientMessage</code>",id:"verifyclientmessage",level:2},{value:"<code>CheckForMisbehaviour</code>",id:"checkformisbehaviour",level:2},{value:"<code>UpdateStateOnMisbehaviour</code>",id:"updatestateonmisbehaviour",level:2},{value:"<code>UpdateState</code>",id:"updatestate",level:2},{value:"Putting it all together",id:"putting-it-all-together",level:2}],p={toc:d},c="wrapper";function g(e){let{components:t,...n}=e;return(0,a.yg)(c,(0,i.A)({},p,n,{components:t,mdxType:"MDXLayout"}),(0,a.yg)("h1",{id:"handling-clientmessages-updates-and-misbehaviour"},"Handling ",(0,a.yg)("inlineCode",{parentName:"h1"},"ClientMessage"),"s: updates and misbehaviour"),(0,a.yg)("p",null,"As mentioned before in the documentation about ",(0,a.yg)("a",{parentName:"p",href:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/consensus-state"},"implementing the ",(0,a.yg)("inlineCode",{parentName:"a"},"ConsensusState")," interface"),", ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v7.0.0/modules/core/exported/client.go#L147"},(0,a.yg)("inlineCode",{parentName:"a"},"ClientMessage"))," is an interface used to update an IBC client. This update may be performed by:"),(0,a.yg)("ul",null,(0,a.yg)("li",{parentName:"ul"},"a single header,"),(0,a.yg)("li",{parentName:"ul"},"a batch of headers,"),(0,a.yg)("li",{parentName:"ul"},"evidence of misbehaviour,"),(0,a.yg)("li",{parentName:"ul"},"or any type which when verified produces a change to the consensus state of the IBC client.")),(0,a.yg)("p",null,"This interface has been purposefully kept generic in order to give the maximum amount of flexibility to the light client implementer."),(0,a.yg)("h2",{id:"implementing-the-clientmessage-interface"},"Implementing the ",(0,a.yg)("inlineCode",{parentName:"h2"},"ClientMessage")," interface"),(0,a.yg)("p",null,"Find the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," interface in ",(0,a.yg)("inlineCode",{parentName:"p"},"modules/core/exported"),":"),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-go"},"type ClientMessage interface {\n  proto.Message\n\n  ClientType() string\n  ValidateBasic() error\n}\n")),(0,a.yg)("p",null,"The ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," will be passed to the client to be used in ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v7.0.0/modules/core/02-client/keeper/client.go#L48"},(0,a.yg)("inlineCode",{parentName:"a"},"UpdateClient")),", which retrieves the ",(0,a.yg)("inlineCode",{parentName:"p"},"LightClientModule")," by client type (parsed from the client ID available in ",(0,a.yg)("inlineCode",{parentName:"p"},"MsgUpdateClient"),"). This ",(0,a.yg)("inlineCode",{parentName:"p"},"LightClientModule")," implements the ",(0,a.yg)("a",{parentName:"p",href:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/light-client-module"},(0,a.yg)("inlineCode",{parentName:"a"},"LightClientModule")," interface")," for its specific consenus type (e.g. Tendermint)."),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"UpdateClient")," will then handle a number of cases including misbehaviour and/or updating the consensus state, utilizing the specific methods defined in the relevant ",(0,a.yg)("inlineCode",{parentName:"p"},"LightClientModule"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-go"},"VerifyClientMessage(ctx sdk.Context, clientID string, clientMsg ClientMessage) error\nCheckForMisbehaviour(ctx sdk.Context, clientID string, clientMsg ClientMessage) bool\nUpdateStateOnMisbehaviour(ctx sdk.Context, clientID string, clientMsg ClientMessage)\nUpdateState(ctx sdk.Context, clientID string, clientMsg ClientMessage) []Height\n")),(0,a.yg)("h2",{id:"handling-updates-and-misbehaviour"},"Handling updates and misbehaviour"),(0,a.yg)("p",null,"The functions for handling updates to a light client and evidence of misbehaviour are all found in the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/501a8462345da099144efe91d495bfcfa18d760d/modules/core/exported/client.go#L51"},(0,a.yg)("inlineCode",{parentName:"a"},"LightClientModule"))," interface, and will be discussed below."),(0,a.yg)("blockquote",null,(0,a.yg)("p",{parentName:"blockquote"},"It is important to note that ",(0,a.yg)("inlineCode",{parentName:"p"},"Misbehaviour")," in this particular context is referring to misbehaviour on the chain level intended to fool the light client. This will be defined by each light client.")),(0,a.yg)("h2",{id:"verifyclientmessage"},(0,a.yg)("inlineCode",{parentName:"h2"},"VerifyClientMessage")),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"VerifyClientMessage")," must verify a ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage"),". A ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," could be a ",(0,a.yg)("inlineCode",{parentName:"p"},"Header"),", ",(0,a.yg)("inlineCode",{parentName:"p"},"Misbehaviour"),", or batch update. To understand how to implement a ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage"),", please refer to the ",(0,a.yg)("a",{parentName:"p",href:"#implementing-the-clientmessage-interface"},"Implementing the ",(0,a.yg)("inlineCode",{parentName:"a"},"ClientMessage")," interface")," section."),(0,a.yg)("p",null,"It must handle each type of ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," appropriately. Calls to ",(0,a.yg)("inlineCode",{parentName:"p"},"CheckForMisbehaviour"),", ",(0,a.yg)("inlineCode",{parentName:"p"},"UpdateState"),", and ",(0,a.yg)("inlineCode",{parentName:"p"},"UpdateStateOnMisbehaviour")," will assume that the content of the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," has been verified and can be trusted. An error should be returned if the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," fails to verify."),(0,a.yg)("p",null,"For an example of a ",(0,a.yg)("inlineCode",{parentName:"p"},"VerifyClientMessage")," implementation, please check the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/76730ff030b52a351096ee941b7e4da44af9f059/modules/light-clients/07-tendermint/update.go#L23"},"Tendermint light client"),"."),(0,a.yg)("h2",{id:"checkformisbehaviour"},(0,a.yg)("inlineCode",{parentName:"h2"},"CheckForMisbehaviour")),(0,a.yg)("p",null,"Checks for evidence of a misbehaviour in ",(0,a.yg)("inlineCode",{parentName:"p"},"Header")," or ",(0,a.yg)("inlineCode",{parentName:"p"},"Misbehaviour")," type. It assumes the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," has already been verified."),(0,a.yg)("p",null,"For an example of a ",(0,a.yg)("inlineCode",{parentName:"p"},"CheckForMisbehaviour")," implementation, please check the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/76730ff030b52a351096ee941b7e4da44af9f059/modules/light-clients/07-tendermint/misbehaviour_handle.go#L22"},"Tendermint light client"),"."),(0,a.yg)("blockquote",null,(0,a.yg)("p",{parentName:"blockquote"},"The Tendermint light client ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v7.0.0/modules/light-clients/07-tendermint/misbehaviour.go"},"defines ",(0,a.yg)("inlineCode",{parentName:"a"},"Misbehaviour"))," as two different types of situations: a situation where two conflicting ",(0,a.yg)("inlineCode",{parentName:"p"},"Header"),"s with the same height have been submitted to update a client's ",(0,a.yg)("inlineCode",{parentName:"p"},"ConsensusState")," within the same trusting period, or that the two conflicting ",(0,a.yg)("inlineCode",{parentName:"p"},"Header"),"s have been submitted at different heights but the consensus states are not in the correct monotonic time ordering (BFT time violation). More explicitly, updating to a new height must have a timestamp greater than the previous consensus state, or, if inserting a consensus at a past height, then time must be less than those heights which come after and greater than heights which come before.")),(0,a.yg)("h2",{id:"updatestateonmisbehaviour"},(0,a.yg)("inlineCode",{parentName:"h2"},"UpdateStateOnMisbehaviour")),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"UpdateStateOnMisbehaviour")," should perform appropriate state changes on a client state given that misbehaviour has been detected and verified. This method should only be called when misbehaviour is detected, as it does not perform any misbehaviour checks. Notably, it should freeze the client so that calling the ",(0,a.yg)("inlineCode",{parentName:"p"},"Status")," function on the associated client state no longer returns ",(0,a.yg)("inlineCode",{parentName:"p"},"Active"),"."),(0,a.yg)("p",null,"For an example of a ",(0,a.yg)("inlineCode",{parentName:"p"},"UpdateStateOnMisbehaviour")," implementation, please check the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/76730ff030b52a351096ee941b7e4da44af9f059/modules/light-clients/07-tendermint/update.go#L202"},"Tendermint light client"),"."),(0,a.yg)("h2",{id:"updatestate"},(0,a.yg)("inlineCode",{parentName:"h2"},"UpdateState")),(0,a.yg)("p",null,(0,a.yg)("inlineCode",{parentName:"p"},"UpdateState")," updates and stores as necessary any associated information for an IBC client, such as the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientState")," and corresponding ",(0,a.yg)("inlineCode",{parentName:"p"},"ConsensusState"),". It should perform a no-op on duplicate updates."),(0,a.yg)("p",null,"It assumes the ",(0,a.yg)("inlineCode",{parentName:"p"},"ClientMessage")," has already been verified."),(0,a.yg)("p",null,"For an example of a ",(0,a.yg)("inlineCode",{parentName:"p"},"UpdateState")," implementation, please check the ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/76730ff030b52a351096ee941b7e4da44af9f059/modules/light-clients/07-tendermint/update.go#L134"},"Tendermint light client"),"."),(0,a.yg)("h2",{id:"putting-it-all-together"},"Putting it all together"),(0,a.yg)("p",null,"The ",(0,a.yg)("inlineCode",{parentName:"p"},"02-client")," ",(0,a.yg)("inlineCode",{parentName:"p"},"Keeper")," module in ibc-go offers a reference as to how these functions will be used to ",(0,a.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v7.0.0/modules/core/02-client/keeper/client.go#L48"},"update the client"),"."),(0,a.yg)("pre",null,(0,a.yg)("code",{parentName:"pre",className:"language-go"},"clientModule, found := k.router.GetRoute(clientID)\nif !found {\n  return errorsmod.Wrap(types.ErrRouteNotFound, clientID)\n}\n\nif err := clientModule.VerifyClientMessage(ctx, clientID, clientMsg); err != nil {\n  return err\n}\n\nfoundMisbehaviour := clientModule.CheckForMisbehaviour(ctx, clientID, clientMsg)\nif foundMisbehaviour {\n  clientModule.UpdateStateOnMisbehaviour(ctx, clientID, clientMsg)\n  // emit misbehaviour event\n  return \n}\n\nclientModule.UpdateState(ctx, clientID, clientMsg) // expects no-op on duplicate header\n// emit update event\nreturn\n")))}g.isMDXComponent=!0}}]);