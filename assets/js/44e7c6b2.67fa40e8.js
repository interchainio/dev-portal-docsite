"use strict";(self.webpackChunkdev_portal_docsite=self.webpackChunkdev_portal_docsite||[]).push([[15848],{15680:(e,a,t)=>{t.d(a,{xA:()=>d,yg:()=>u});var i=t(96540);function n(e,a,t){return a in e?Object.defineProperty(e,a,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[a]=t,e}function o(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);a&&(i=i.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,i)}return t}function l(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?o(Object(t),!0).forEach((function(a){n(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}function r(e,a){if(null==e)return{};var t,i,n=function(e,a){if(null==e)return{};var t,i,n={},o=Object.keys(e);for(i=0;i<o.length;i++)t=o[i],a.indexOf(t)>=0||(n[t]=e[t]);return n}(e,a);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(i=0;i<o.length;i++)t=o[i],a.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(n[t]=e[t])}return n}var c=i.createContext({}),s=function(e){var a=i.useContext(c),t=a;return e&&(t="function"==typeof e?e(a):l(l({},a),e)),t},d=function(e){var a=s(e.components);return i.createElement(c.Provider,{value:a},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var a=e.children;return i.createElement(i.Fragment,{},a)}},m=i.forwardRef((function(e,a){var t=e.components,n=e.mdxType,o=e.originalType,c=e.parentName,d=r(e,["components","mdxType","originalType","parentName"]),p=s(t),m=n,u=p["".concat(c,".").concat(m)]||p[m]||h[m]||o;return t?i.createElement(u,l(l({ref:a},d),{},{components:t})):i.createElement(u,l({ref:a},d))}));function u(e,a){var t=arguments,n=a&&a.mdxType;if("string"==typeof e||n){var o=t.length,l=new Array(o);l[0]=m;var r={};for(var c in a)hasOwnProperty.call(a,c)&&(r[c]=a[c]);r.originalType=e,r[p]="string"==typeof e?e:n,l[1]=r;for(var s=2;s<o;s++)l[s]=t[s];return i.createElement.apply(null,l)}return i.createElement.apply(null,t)}m.displayName="MDXCreateElement"},21523:(e,a,t)=>{t.r(a),t.d(a,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>s});var i=t(58168),n=(t(96540),t(15680));const o={title:"Overview",sidebar_label:"Overview",sidebar_position:1,slug:"/middleware/callbacks/overview"},l="Overview",r={unversionedId:"docs/middleware/callbacks/overview",id:"docs/middleware/callbacks/overview",title:"Overview",description:"Learn about what the Callbacks Middleware is, and how to build custom modules that utilize the Callbacks Middleware functionality",source:"@site/ibc-go/docs/04-middleware/01-callbacks/01-overview.md",sourceDirName:"docs/04-middleware/01-callbacks",slug:"/middleware/callbacks/overview",permalink:"/dev-portal-docsite/ibc-go/next/middleware/callbacks/overview",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Overview",sidebar_label:"Overview",sidebar_position:1,slug:"/middleware/callbacks/overview"},sidebar:"defaultSidebar",previous:{title:"Overview",permalink:"/dev-portal-docsite/ibc-go/next/ibc/light-clients/tendermint/overview"},next:{title:"Integration",permalink:"/dev-portal-docsite/ibc-go/next/middleware/callbacks/integration"}},c={},s=[{value:"What is the Callbacks Middleware?",id:"what-is-the-callbacks-middleware",level:2},{value:"Concepts",id:"concepts",level:2},{value:"Known Limitations",id:"known-limitations",level:2}],d={toc:s},p="wrapper";function h(e){let{components:a,...o}=e;return(0,n.yg)(p,(0,i.A)({},d,o,{components:a,mdxType:"MDXLayout"}),(0,n.yg)("h1",{id:"overview"},"Overview"),(0,n.yg)("p",null,"Learn about what the Callbacks Middleware is, and how to build custom modules that utilize the Callbacks Middleware functionality "),(0,n.yg)("h2",{id:"what-is-the-callbacks-middleware"},"What is the Callbacks Middleware?"),(0,n.yg)("p",null,"IBC was designed with callbacks between core IBC and IBC applications. IBC apps would send a packet to core IBC, and receive a callback on every step of that packet's lifecycle. This allows IBC applications to be built on top of core IBC, and to be able to execute custom logic on packet lifecycle events (e.g. unescrow tokens for ICS-20)."),(0,n.yg)("p",null,"This setup worked well for off-chain users interacting with IBC applications. However, we are now seeing the desire for secondary applications (e.g. smart contracts, modules) to call into IBC apps as part of their state machine logic and then do some actions on packet lifecycle events."),(0,n.yg)("p",null,"The Callbacks Middleware allows for this functionality by allowing the packets of the underlying IBC applications to register callbacks to secondary applications for lifecycle events. These callbacks are then executed by the Callbacks Middleware when the corresponding packet lifecycle event occurs."),(0,n.yg)("p",null,"After much discussion, the design was expanded to ",(0,n.yg)("a",{parentName:"p",href:"/ibc-go/architecture/adr-008-app-caller-cbs"},"an ADR"),", and the Callbacks Middleware is an implementation of that ADR."),(0,n.yg)("h2",{id:"concepts"},"Concepts"),(0,n.yg)("p",null,"Callbacks Middleware was built with smart contracts in mind, but can be used by any secondary application that wants to allow IBC packets to call into it. Think of the Callbacks Middleware as a bridge between core IBC and a secondary application."),(0,n.yg)("p",null,"We have the following definitions:"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Underlying IBC application"),": The IBC application that is wrapped by the Callbacks Middleware. This is the IBC application that is actually sending and receiving packet lifecycle events from core IBC. For example, the transfer module, or the ICA controller submodule."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"IBC Actor"),": IBC Actor is an on-chain or off-chain entity that can initiate a packet on the underlying IBC application. For example, a smart contract, an off-chain user, or a module that sends a transfer packet are all IBC Actors."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Secondary application"),": The application that is being called into by the Callbacks Middleware for packet lifecycle events. This is the application that is receiving the callback directly from the Callbacks Middleware module. For example, the ",(0,n.yg)("inlineCode",{parentName:"li"},"x/wasm")," module."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Callback Actor"),": The on-chain smart contract or module that is registered to receive callbacks from the secondary application. For example, a Wasm smart contract (gatekeeped by the ",(0,n.yg)("inlineCode",{parentName:"li"},"x/wasm")," module). Note that the Callback Actor is not necessarily the same as the IBC Actor. For example, an off-chain user can initiate a packet on the underlying IBC application, but the Callback Actor could be a smart contract. The secondary application may want to check that the IBC Actor is allowed to call into the Callback Actor, for example, by checking that the IBC Actor is the same as the Callback Actor."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Callback Address"),": Address of the Callback Actor. This is the address that the secondary application will call into when a packet lifecycle event occurs. For example, the address of the Wasm smart contract."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"Maximum gas limit"),": The maximum amount of gas that the Callbacks Middleware will allow the secondary application to use when it executes its custom logic."),(0,n.yg)("li",{parentName:"ul"},(0,n.yg)("inlineCode",{parentName:"li"},"User defined gas limit"),": The amount of gas that the IBC Actor wants to allow the secondary application to use when it executes its custom logic. This is the gas limit that the IBC Actor specifies when it sends a packet to the underlying IBC application. This cannot be greater than the maximum gas limit.")),(0,n.yg)("p",null,"Think of the secondary application as a bridge between the Callbacks Middleware and the Callback Actor. The secondary application is responsible for executing the custom logic of the Callback Actor when a packet lifecycle event occurs. The secondary application is also responsible for checking that the IBC Actor is allowed to call into the Callback Actor."),(0,n.yg)("p",null,"Note that it is possible that the IBC Actor, Secondary Application, and Callback Actor are all the same entity. In which case, the Callback Address should be the secondary application's module address."),(0,n.yg)("p",null,"The following diagram shows how a typical ",(0,n.yg)("inlineCode",{parentName:"p"},"RecvPacket"),", ",(0,n.yg)("inlineCode",{parentName:"p"},"AcknowledgementPacket"),", and ",(0,n.yg)("inlineCode",{parentName:"p"},"TimeoutPacket")," execution flow would look like:\n",(0,n.yg)("img",{alt:"callbacks-middleware",src:t(97490).A,width:"745",height:"450"})),(0,n.yg)("p",null,"And the following diagram shows how a typical ",(0,n.yg)("inlineCode",{parentName:"p"},"SendPacket")," and ",(0,n.yg)("inlineCode",{parentName:"p"},"WriteAcknowledgement")," execution flow would look like:\n",(0,n.yg)("img",{alt:"callbacks-middleware",src:t(44882).A,width:"745",height:"450"})),(0,n.yg)("h2",{id:"known-limitations"},"Known Limitations"),(0,n.yg)("ul",null,(0,n.yg)("li",{parentName:"ul"},"Callbacks are always executed after the underlying IBC application has executed its logic."),(0,n.yg)("li",{parentName:"ul"},"Maximum gas limit is hardcoded manually during wiring. It requires a coordinated upgrade to change the maximum gas limit."),(0,n.yg)("li",{parentName:"ul"},"The receive packet callback does not pass the relayer address to the secondary application. This is so that we can use the same callback for both synchronous and asynchronous acknowledgements."),(0,n.yg)("li",{parentName:"ul"},"The receive packet callback does not pass IBC Actor's address, this is because the IBC Actor lives in the counterparty chain and cannot be trusted.")),(0,n.yg)("admonition",{type:"warning"},(0,n.yg)("p",{parentName:"admonition"},"If the callbacks middleware wraps the transfer application, we strongly discourage the usage of source callbacks if ",(0,n.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v9.0.0-rc.0/proto/ibc/applications/transfer/v1/tx.proto#L54-L55"},(0,n.yg)("inlineCode",{parentName:"a"},"MsgTransfer")," includes forwarding information")," (which is only supported from ICS20 v2). Source callback information will be executed on the last hop before the destination chain, not on the sending chain. The explanation for this behaviour is that, if the tokens are routed through intermediary chains, then the transfer application on the sending chain will construct a packet data where the  ",(0,n.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v9.0.0-rc.0/proto/ibc/applications/transfer/v2/packet.proto#L38"},(0,n.yg)("inlineCode",{parentName:"a"},"memo")," field")," is empty, and any ",(0,n.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v9.0.0-rc.0/proto/ibc/applications/transfer/v1/tx.proto#L51"},"memo string")," included in ",(0,n.yg)("inlineCode",{parentName:"p"},"MsgTransfer")," is placed in the ",(0,n.yg)("a",{parentName:"p",href:"https://github.com/cosmos/ibc-go/blob/v9.0.0-rc.0/proto/ibc/applications/transfer/v2/packet.proto#L48"},(0,n.yg)("inlineCode",{parentName:"a"},"destination_memo")," field"),". This makes it impossible to trigger the source callbacks on the sending chain, since the memo string is not available in the ",(0,n.yg)("inlineCode",{parentName:"p"},"memo")," field. Then, on the chain before the final destination chain, the transfer application will construct the packet data with the memo string back in the ",(0,n.yg)("inlineCode",{parentName:"p"},"memo")," field, so that it can be consumed by the callbacks middleware on the destination chain. However, if the ",(0,n.yg)("inlineCode",{parentName:"p"},"memo")," field of ",(0,n.yg)("inlineCode",{parentName:"p"},"FungibleTokenPacketDataV2")," is not empty on the chain before the final destination and the transfer application on that chain is wrapped by callbacks middleware, then the source callbacks would be triggered. Therefore, in order to prevent this unexpected behaviour (i.e. source callbacks triggered not on sending chain, but on the intermediary chain before the final destination) we are strongly recommending to not include source callbacks information in the ",(0,n.yg)("inlineCode",{parentName:"p"},"memo")," field of ",(0,n.yg)("inlineCode",{parentName:"p"},"MsgTransfer"),".")))}h.isMDXComponent=!0},97490:(e,a,t)=>{t.d(a,{A:()=>i});const i=t.p+"assets/images/callbackflow-46625824fa747b580e048b1550e5a80a.svg"},44882:(e,a,t)=>{t.d(a,{A:()=>i});const i=t.p+"assets/images/ics4-callbackflow-aed6c204e55a0cbd1a8f7e23e2439d96.svg"}}]);